"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9223],{22181:function(e,n,t){t.d(n,{UB:function(){return v},Ve:function(){return f},Wn:function(){return h},bD:function(){return b},kJ:function(){return m},rM:function(){return p}});var i=t(7297),o=t(75063);function r(){var e=(0,i.Z)(['\n  query GetFinancialJob(\n    $adminId: Int\n    $customerId: Int\n    $endDate: timestamptz\n    $startDate: timestamptz\n    $limit: Int\n    $status: [String]\n    $managerId: Int\n    $locationId: Int\n    $offset: Int\n    $supplierId: Int\n    $q: String\n    $orderBy: Job_order_by!\n  ) {\n    jobs: Job(\n      limit: $limit\n      offset: $offset\n      where: {\n        type: { _in: ["reactive", "ppm"] }\n        _and: [\n          {\n            _or: [\n              { reference: { _ilike: $q } }\n              { title: { _ilike: $q } }\n              { number: { _ilike: $q } }\n              { number: { _ilike: $q } }\n              { Invoices: { invoiceNumber: { _ilike: $q } } }\n            ]\n          }\n          {\n            _or: [\n              { _and: [{ timingStart: { _gte: $startDate } }, { timingStart: { _lte: $endDate } }] }\n              { _and: [{ scheduledAt: { _gte: $startDate } }, { scheduledAt: { _lte: $endDate } }] }\n            ]\n          }\n        ]\n        status: { _in: $status }\n        customerId: { _eq: $customerId }\n        supplierId: { _eq: $supplierId }\n        managerId: { _eq: $managerId }\n        adminId: { _eq: $adminId }\n        locationId: { _eq: $locationId }\n      }\n      order_by: [$orderBy]\n    ) {\n      id\n      type\n      number\n      status\n      description\n      reference\n      timingStart\n      scheduledAt\n      createdAt\n\n      customerTotal: customerFinances(path: "amountInfo.total")\n      supplierTotal: supplierFinances(path: "amountInfo.total")\n      customerVatTotal: customerFinances(path: "amountInfo.vatTotal")\n      supplierVatTotal: supplierFinances(path: "amountInfo.vatTotal")\n      customerExpensesTotal: customerFinances(path: "expensesInfo.expensesTotal")\n      supplierExpensesTotal: supplierFinances(path: "expensesInfo.expensesTotal")\n      customerRebateAmount: customerFinances(path: "rebate.amount")\n\n      slaId\n      invoices: Invoices(order_by: { createdAt: desc }) {\n        invoiceNumber\n      }\n      customer: Customer {\n        id\n        name\n      }\n      supplier: Supplier {\n        id\n        name\n      }\n      location: Location {\n        id\n        name\n      }\n      sublocation: Sublocation {\n        id\n        name\n      }\n      sla: SLA {\n        name\n      }\n      manager: Manager {\n        fullName\n        nameLast\n        nameFirst\n        id\n      }\n      service: Service {\n        id\n        name\n      }\n    }\n    meta: Job_aggregate(\n      where: {\n        type: { _in: ["reactive", "ppm"] }\n        _and: [\n          {\n            _or: [\n              { reference: { _ilike: $q } }\n              { title: { _ilike: $q } }\n              { number: { _ilike: $q } }\n              { number: { _ilike: $q } }\n              { Invoices: { invoiceNumber: { _ilike: $q } } }\n            ]\n          }\n          {\n            _or: [\n              { _and: [{ timingStart: { _gte: $startDate } }, { timingStart: { _lte: $endDate } }] }\n              { _and: [{ scheduledAt: { _gte: $startDate } }, { scheduledAt: { _lte: $endDate } }] }\n            ]\n          }\n        ]\n        status: { _in: $status }\n        customerId: { _eq: $customerId }\n        supplierId: { _eq: $supplierId }\n        managerId: { _eq: $managerId }\n        adminId: { _eq: $adminId }\n        locationId: { _eq: $locationId }\n      }\n    ) {\n      aggregate {\n        totalCount: count\n      }\n    }\n  }\n']);return r=function(){return e},e}function a(){var e=(0,i.Z)(['\n  query GetCustomers(\n    $customerManagerId: Int\n    $date: timestamptz\n    $limit: Int\n    $offset: Int\n    $q: String\n    $orderBy: Account_order_by!\n    $status: String\n  ) {\n    customers: Account(\n      limit: $limit\n      offset: $offset\n      where: {\n        type: { _eq: "customer" }\n        createdAt: { _eq: $date }\n        managerId: { _eq: $customerManagerId }\n        name: { _ilike: $q }\n        status: { _eq: $status }\n      }\n      order_by: [$orderBy]\n    ) {\n      id\n      createdAt\n      name\n      companyNumber\n      vatId\n      website\n      status\n      addresses: Addresses(where: { entity: { _eq: "Account" } }) {\n        id\n        registered\n        operating\n        trading\n        invoice\n        status\n        createdAt\n        address: Address {\n          id\n          name\n          addressLine1\n          addressLine2\n          addressLine3\n          city\n          county\n          geo\n          postCode\n          country: Country {\n            id\n            name\n          }\n        }\n      }\n      locations: Account_Locations {\n        id\n      }\n      finance: Financial {\n        id\n        invoicing\n        serviceRate\n        stripeId\n        totalRevenue\n        unpaidInvoices\n        creditLimit\n        creditRating\n        createdAt\n        amountOutstanding\n        accountId\n        approvalThreshold\n        arrangementFee\n        spendThreshold\n        defaultPaymentMethod\n      }\n      manager: Manager {\n        id\n        nameFirst\n        nameLast\n      }\n      contactUsers: Account_Users(where: { isContact: { _eq: true } }) {\n        id\n        role\n        position\n        isContact\n        lastSignInAt\n        userId\n        user: User {\n          id\n          name: nameFirst\n          nameFirst\n          nameLast\n          phone\n          status\n          email\n          createdAt\n          fullName\n          accounts: Account_Users {\n            id\n            role\n            position\n            isContact\n            status\n            account: Account {\n              id\n              name\n              type\n            }\n          }\n        }\n      }\n    }\n    meta: Account_aggregate(\n      where: {\n        type: { _eq: "customer" }\n        createdAt: { _eq: $date }\n        managerId: { _eq: $customerManagerId }\n        name: { _ilike: $q }\n        status: { _eq: $status }\n      }\n    ) {\n      aggregate {\n        totalCount: count\n      }\n    }\n  }\n']);return a=function(){return e},e}function s(){var e=(0,i.Z)(['\n  query GetCustomer($id: Int!) {\n    customer: Account_by_pk(id: $id) {\n      id\n      name\n      clientType: ClientType {\n        id\n        name\n      }\n      structure\n      companyNumber\n      vatId\n      website\n      status\n      createdAt\n      updatedAt\n      status\n      type\n      meta\n      usersMeta: Account_Users_aggregate {\n        aggregate {\n          count\n        }\n      }\n      propertiesMeta: Account_Locations_aggregate {\n        aggregate {\n          count\n        }\n      }\n      jobsMeta: CustomerJobs_aggregate {\n        aggregate {\n          count\n        }\n      }\n      addresses: Addresses(where: { entity: { _eq: "Account" } }) {\n        id\n        registered\n        operating\n        trading\n        invoice\n        status\n        createdAt\n        address: Address {\n          id\n          name\n          addressLine1\n          addressLine2\n          addressLine3\n          city\n          county\n          geo\n          postCode\n          country: Country {\n            id\n            name\n          }\n        }\n      }\n      manager: Manager {\n        id\n        nameFirst\n        nameLast\n        phone\n        email\n      }\n      contactUsers: Account_Users(where: { isContact: { _eq: true } }) {\n        id\n        role\n        position\n        isContact\n        lastSignInAt\n        userId\n        user: User {\n          id\n          name: nameFirst\n          nameFirst\n          nameLast\n          phone\n          status\n          email\n          createdAt\n          fullName\n          accounts: Account_Users {\n            id\n            role\n            position\n            isContact\n            status\n            account: Account {\n              id\n              name\n              type\n            }\n          }\n        }\n      }\n      bankAccounts: BankAccounts {\n        id\n        stripeId\n        accountNumber\n        routingNumber\n        bic\n        iban\n        status\n        default\n        createdAt\n      }\n      media: Media {\n        id\n        medium: Medium {\n          id\n          category\n          filename\n          meta\n          type\n        }\n      }\n      cards: Cards {\n        id\n        stripeId\n        type\n        last4\n        expYear\n        expMonth\n        status\n        default\n        createdAt\n      }\n      jobs: CustomerJobs {\n        id\n        title\n      }\n      finance: Financial {\n        id\n        invoicing\n        serviceRate\n        stripeId\n        totalRevenue\n        unpaidInvoices\n        creditLimit\n        creditRating\n        createdAt\n        amountOutstanding\n        accountId\n        approvalThreshold\n        arrangementFee\n        spendThreshold\n        defaultPaymentMethod\n      }\n      accountEntries: AccountEntries(order_by: { createdAt: asc }) {\n        id\n        outstandingAmount\n        type\n        entryId\n        currencyId\n        createdAt\n        balance\n        amount\n        accountId\n        updatedAt\n      }\n    }\n  }\n']);return s=function(){return e},e}function c(){var e=(0,i.Z)(["\n  query GetCustomerManage($id: Int!) {\n    customer: Account_by_pk(id: $id) {\n      id\n      name\n      website\n      companyNumber\n      vatId\n      meta\n      contactUsers: Account_Users(where: { isContact: { _eq: true } }) {\n        id\n        isContact\n        userId\n        user: User {\n          id\n          email\n          fullName\n          meta\n          name: nameFirst\n          nameFirst\n          nameLast\n          phone\n          status\n        }\n      }\n      clientType: ClientType {\n        id\n        label: name\n        value: id\n      }\n      status\n      managerSelected: Manager {\n        id\n        label: fullName\n        value: id\n      }\n    }\n  }\n"]);return c=function(){return e},e}function u(){var e=(0,i.Z)(["\n  mutation AddCustomer($objects: [Account_insert_input!]!) {\n    insert_Account(objects: $objects) {\n      returning {\n        id\n      }\n    }\n  }\n"]);return u=function(){return e},e}function d(){var e=(0,i.Z)(["\n  mutation UpdateCustomer(\n    $customerId: Int!\n    $customer: Account_set_input\n    $userId: Int!\n    $user: User_set_input\n    $hasUpdateUser: Boolean!\n  ) {\n    update_Account_by_pk(pk_columns: { id: $customerId }, _set: $customer) {\n      id\n    }\n    update_User_by_pk(pk_columns: { id: $userId }, _set: $user) @include(if: $hasUpdateUser) {\n      id\n    }\n  }\n"]);return d=function(){return e},e}function l(){var e=(0,i.Z)(["\n  mutation AddFinancial($objects: [Financial_insert_input!]!) {\n    insert_Financial(objects: $objects) {\n      returning {\n        id\n        accountId\n        locationId\n      }\n    }\n  }\n"]);return l=function(){return e},e}(0,o.Ps)(r());var m=(0,o.Ps)(a()),v=(0,o.Ps)(s()),p=(0,o.Ps)(c()),f=(0,o.Ps)(u()),h=(0,o.Ps)(d()),b=(0,o.Ps)(l())},246:function(e,n,t){t.d(n,{A:function(){return O}});var i=t(26042),o=t(69396),r=t(828),a=t(85893),s=t(67294),c=t(30381),u=t.n(c),d=t(45697),l=t(11163),m=t.n(l),v=t(57460),p=t.n(v),f=t(96486),h=t(11057),b=t(90629),x=t(51233),g=t(15861),y=t(98456),I=t(81261),j=t(29952),Z=t(34187),_=t(45451),C=t(59505),w=t(21830),N=t(48795),T=t(6812),S=t(73359),R=t(7297),A=t(75063);function k(){var e=(0,R.Z)(['\n  query GetFinancialJob(\n    $adminId: Int\n    $customerId: Int\n    $endDate: timestamptz\n    $startDate: timestamptz\n    $limit: Int\n    $status: [String]\n    $managerId: Int\n    $locationId: Int\n    $offset: Int\n    $supplierId: Int\n    $q: String\n    $orderBy: Job_order_by!\n    $sublocationId: Int\n    $userId: Int\n  ) {\n    jobs: Job(\n      limit: $limit\n      offset: $offset\n      where: {\n        type: { _in: ["reactive", "ppm"] }\n        _and: [\n          {\n            _or: [\n              { reference: { _ilike: $q } }\n              { title: { _ilike: $q } }\n              { number: { _ilike: $q } }\n              { number: { _ilike: $q } }\n              { Invoices: { invoiceNumber: { _ilike: $q } } }\n            ]\n          }\n          {\n            _or: [\n              { _and: [{ timingStart: { _gte: $startDate } }, { timingStart: { _lte: $endDate } }] }\n              { _and: [{ scheduledAt: { _gte: $startDate } }, { scheduledAt: { _lte: $endDate } }] }\n            ]\n          }\n        ]\n        status: { _in: $status }\n        customerId: { _eq: $customerId }\n        supplierId: { _eq: $supplierId }\n        managerId: { _eq: $managerId }\n        adminId: { _eq: $adminId }\n        locationId: { _eq: $locationId }\n        sublocationId: { _eq: $sublocationId }\n        _or: [{ customerUserId: { _eq: $userId } }, { supplierUserId: { _eq: $userId } }]\n        ','\n      }\n      order_by: [$orderBy]\n    ) {\n      id\n      type\n      number\n      status\n      description\n      reference\n      timingStart\n      scheduledAt\n      createdAt\n      customerTotal: customerFinances(path: "amountInfo.total")\n      supplierTotal: supplierFinances(path: "amountInfo.total")\n      customerVatTotal: customerFinances(path: "amountInfo.vatTotal")\n      supplierVatTotal: supplierFinances(path: "amountInfo.vatTotal")\n      customerExpensesTotal: customerFinances(path: "expensesInfo.expensesTotal")\n      supplierExpensesTotal: supplierFinances(path: "expensesInfo.expensesTotal")\n      customerRebateAmount: customerFinances(path: "rebate.amount")\n      slaId\n      tags: Taxonomy(\n        where: {\n          entity: { _eq: "Job" }\n          Taxonomy: { status: { _eq: "active" }, type: { _eq: "tags" } }\n        }\n      ) {\n        id\n        tag: Taxonomy {\n          id\n          name\n          meta\n          type\n        }\n      }\n      invoices: Invoices(order_by: { createdAt: desc }) {\n        invoiceNumber\n        outstandingAmounts: AccountEntry {\n          amount: outstandingAmount\n        }\n      }\n      customer: Customer {\n        id\n        name\n      }\n      supplier: Supplier {\n        id\n        name\n      }\n      location: Location {\n        id\n        name\n      }\n      sublocation: Sublocation {\n        id\n        name\n      }\n      sla: SLA {\n        name\n      }\n      manager: Manager {\n        fullName\n        nameLast\n        nameFirst\n        id\n      }\n      service: Service {\n        id\n        name\n      }\n    }\n    meta: Job_aggregate(\n      where: {\n        type: { _in: ["reactive", "ppm"] }\n        _and: [\n          {\n            _or: [\n              { reference: { _ilike: $q } }\n              { title: { _ilike: $q } }\n              { number: { _ilike: $q } }\n              { number: { _ilike: $q } }\n              { Invoices: { invoiceNumber: { _ilike: $q } } }\n            ]\n          }\n          {\n            _or: [\n              { _and: [{ timingStart: { _gte: $startDate } }, { timingStart: { _lte: $endDate } }] }\n              { _and: [{ scheduledAt: { _gte: $startDate } }, { scheduledAt: { _lte: $endDate } }] }\n            ]\n          }\n        ]\n        status: { _in: $status }\n        customerId: { _eq: $customerId }\n        supplierId: { _eq: $supplierId }\n        managerId: { _eq: $managerId }\n        adminId: { _eq: $adminId }\n        locationId: { _eq: $locationId }\n        sublocationId: { _eq: $sublocationId }\n        _or: [{ customerUserId: { _eq: $userId } }, { supplierUserId: { _eq: $userId } }]\n        ',"\n\n      }\n    ) {\n      aggregate {\n        totalCount: count\n      }\n    }\n  }\n"]);return k=function(){return e},e}var $=function(e){var n=e.tagsWhere,t=void 0===n?"":n;return(0,A.Ps)(k(),t,t)},D=t(16605),q=t(91027),P=t(26186),F=t(11082),E=function(e,n,t){var i=t.numberPrefix,o=void 0===i?"":i,r=t.numberSuffix,a=void 0===r?"":r,s="customer"===n,c="supplier"===n;return e.map(function(e){var n,t,i,r,u,d,l,m,v,p,f,h,b,x,g,y,I,j,Z,_=e.manager?"".concat(e.manager.nameFirst," ").concat(e.manager.nameLast):"Unassigned",C=e.scheduledAt?(0,P.Z)(e.scheduledAt,!0):e.timingStart?(0,P.Z)(e.timingStart,!0):"-",w=e.customerRebateAmount>0?e.customerVatTotal-e.customerRebateAmount-e.supplierTotal:e.customerTotal-e.supplierTotal;return c?{id:"".concat(o," ").concat(e.number," ").concat(a),type:e.type,invoiceNumber:(null===(n=e.invoices)||void 0===n?void 0:null===(t=n[0])||void 0===t?void 0:t.invoiceNumber)||"-",priority:(null===(i=e.sla)||void 0===i?void 0:i.name)||"-",service:(null===(r=e.service)||void 0===r?void 0:r.name)||"-",description:e.description||"-",location:(null===(u=e.location)||void 0===u?void 0:u.name)||"-",sublocation:(null===(d=e.sublocation)||void 0===d?void 0:d.name)||"-",scheduleDate:C,created:(0,P.Z)(e.createdAt),status:e.status}:s?{id:"".concat(o," ").concat(e.number," ").concat(a),type:e.type,invoiceNumber:(null===(l=e.invoices)||void 0===l?void 0:null===(m=l[0])||void 0===m?void 0:m.invoiceNumber)||"-",ref:e.reference,jobTotal:(0,F.Z)(e.customerVatTotal)||0,expensesAmountCustomer:(0,F.Z)(e.customerExpensesTotal)||0,priority:(null===(v=e.sla)||void 0===v?void 0:v.name)||"-",service:(null===(p=e.service)||void 0===p?void 0:p.name)||"-",description:e.description||"-",manager:_,location:(null===(f=e.location)||void 0===f?void 0:f.name)||"-",sublocation:(null===(h=e.sublocation)||void 0===h?void 0:h.name)||"-",scheduleDate:C,created:(0,P.Z)(e.createdAt),status:e.status}:{id:"".concat(o," ").concat(e.number," ").concat(a),type:e.type,invoiceNumber:(null===(b=e.invoices)||void 0===b?void 0:null===(x=b[0])||void 0===x?void 0:x.invoiceNumber)||"-",ref:e.reference,jobTotal:(0,F.Z)(e.customerVatTotal)||0,expensesAmountCustomer:(0,F.Z)(e.customerExpensesTotal)||0,supplierAmount:(0,F.Z)(e.supplierVatTotal)||0,expensesAmountSupplier:(0,F.Z)(e.supplierExpensesTotal)||0,revenue:(0,F.Z)(w)||0,priority:(null===(g=e.sla)||void 0===g?void 0:g.name)||"-",service:(null===(y=e.service)||void 0===y?void 0:y.name)||"-",description:e.description||"-",manager:_,location:(null===(I=e.location)||void 0===I?void 0:I.name)||"-",sublocation:(null===(j=e.sublocation)||void 0===j?void 0:j.name)||"-",supplier:(null===(Z=e.supplier)||void 0===Z?void 0:Z.name)||"-",scheduleDate:C,created:(0,P.Z)(e.createdAt),status:e.status}})},L=t(74944),W=t(53767),M=t(35374),B=t(12632),J=t(83162),U=t(79928),Y=t(71559),O=function(e){var n,t,c=e.initialFilters,d=e.entityRelationToFetch,v=e.filtersVisibilityModel,R=e.columnVisibilityModel,A=(0,L.x)(),k=A.user,P=A.hasRole,F=(0,W.q)(),O=(null===(n=F.admin.jobSetting)||void 0===n?void 0:n.jobNumberPrefix)||"",X=(null===(t=F.admin.jobSetting)||void 0===t?void 0:t.jobNumberSuffix)||"",z=(0,l.useRouter)().pathname,Q=(0,s.useState)(!1),G=Q[0],K=Q[1],H=(0,s.useState)((0,i.Z)({},c)),ee=H[0],en=H[1],et=(0,M.s)(),ei=(0,B.x)({filters:ee}),eo=ei.initialData,er=ei.ref,ea=(0,T.a)($({tagsWhere:(0,Y.Y)(eo.tags)}),{variables:(0,o.Z)((0,i.Z)({},eo,d),{number:eo.id?String(eo.id):null,startDate:eo.startDate,endDate:eo.endDate,adminId:k.adminId})}),es=ea.data,ec=void 0===es?{jobs:[],meta:{aggregate:{totalCount:0}}}:es,eu=ec.jobs,ed=ec.meta,el=ea.loading,em=ea.refetch,ev=eo.customerId,ep=eo.endDate,ef=eo.locationId,eh=eo.orderBy,eb=eo.startDate,ex=eo.status,eg=eo.supplierId,ey=(0,r.Z)((0,S.t)($({tagsWhere:(0,Y.Y)(eo.tags)}),{variables:{adminId:k.adminId,customerId:ev,endDate:ep,locationId:ef,orderBy:eh,startDate:eb,status:ex,supplierId:eg},onCompleted:function(e){var n,t=E(e.jobs,k.accountType,{numberPrefix:O,numberSuffix:X}),i=(null===(n=e.jobs[0])||void 0===n?void 0:n.id)||"New-report",o=p().unparse(t),r="data:application/octet-stream,"+encodeURIComponent(o);(0,D.S)(r,"".concat(i,"-work-orders.csv"))}}),2),eI=ey[0],ej=ey[1].loading,eZ=function(e){m().push("".concat("/dashboard/issues/","manage?id=").concat(e.number))},e_=function(e){m().push("/dashboard/issues/view?id=".concat(e.number))},eC=function(e){return u()(e).format("YYYY-MM-DD")},ew=function(e){var n=[{context:"secondary",icon:"info",onClick:function(n){return e_(e)},tooltip:"Info"}];return P("admin")&&n.unshift({context:"secondary",icon:"edit",onClick:function(n){return eZ(e)},tooltip:"Edit"}),n},eN=[{headerName:"Job ID",field:"jobId",sortable:!1,flex:1,minWidth:100,renderCell:function(e){var n=e.row;return(0,a.jsx)(N.D,{id:n.id,number:n.number,openCanvas:!0,type:n.type,numberPrefix:O,numberSuffix:X})}},{headerName:"Invoice number",field:"invoiceNumber",sortable:!1,flex:1,minWidth:100},{headerName:"Reference",field:"ref",sortable:!1,flex:1,minWidth:100},{minWidth:300,field:"tags",headerName:"Tags",sortable:!1,renderCell:function(e){var n=e.row;return(0,a.jsx)(U.K,{row:n,refetchQueries:["GetFinancialJob"],entity:"Job"})}},{headerName:"Service",field:"service",sortName:'{"Service": {"name": "ORDER"}}',flex:1,minWidth:100},{headerName:"Priority",field:"priority",sortName:'{"SLA": {"name": "ORDER"}}',flex:1,minWidth:100},{headerName:"Customer",field:"customer",minWidth:200,flex:1,renderCell:function(e){var n,t,i=e.row;return(0,a.jsx)(J.r,{color:"secondary",href:"/dashboard/customers/view?id=".concat(null===(n=i.customer)||void 0===n?void 0:n.id),noWrap:!i.customer,children:(null===(t=i.customer)||void 0===t?void 0:t.name)||"-"})}},{headerName:"Location",field:"location",minWidth:300,flex:1,renderCell:function(e){var n,t,i=e.row;return(0,a.jsx)(J.r,{color:"secondary",href:"/dashboard/properties/view?id=".concat(null===(n=i.location)||void 0===n?void 0:n.id),noWrap:!i.location||P(["supplier","tenant"]),children:(null===(t=i.location)||void 0===t?void 0:t.name)||"-"})}},{headerName:"Customer (NET)",field:"customerNet",minWidth:150,sortable:!1,flex:1,valueFormatter:function(e){var n=e.value;return"\xa3".concat((+(null!=n?n:0)).toFixed(2))}},{headerName:"Amount Outstanding",field:"amountOutstanding",sortable:!1,minWidth:150,flex:1,valueFormatter:function(e){var n=e.value;return"\xa3".concat((+(null!=n?n:0)).toFixed(2))}},{headerName:"Supplier (NET)",field:"supplierNet",minWidth:150,sortable:!1,flex:1,valueFormatter:function(e){var n=e.value;return"\xa3".concat((+(null!=n?n:0)).toFixed(2))}},{headerName:P("admin")?"Net Revenue":"Revenue",field:"revenue",minWidth:150,sortable:!1,flex:1,valueFormatter:function(e){var n=e.value;return"\xa3".concat((+(null!=n?n:0)).toFixed(2))}},{headerName:"Scheduled",field:"scheduleDate",minWidth:130,flex:1},{headerName:"Created",field:"date",flex:1,minWidth:100},{headerName:"Supplier",field:"supplier",sortName:'{"Supplier": {"name": "ORDER"}}',flex:1,minWidth:140,renderCell:function(e){var n,t,i=e.row;return(0,a.jsx)(J.r,{color:"secondary",noWrap:!P("admin")||!i.supplier,href:"/dashboard/suppliers/view?id=".concat(null===(n=i.supplier)||void 0===n?void 0:n.id),children:(null===(t=i.supplier)||void 0===t?void 0:t.name)||""})}},{headerName:"Status",field:"status",flex:1,minWidth:100,renderCell:function(e){var n=e.row;return(0,a.jsx)(C.B,{value:n.status})}},{headerName:"Actions",field:"actions",sortable:!1,minWidth:130,flex:1,renderCell:function(e){var n=e.row;return(0,a.jsx)(w.C,{actionsData:ew,row:n})}}],eT=(0,s.useMemo)(function(){return null==eu?void 0:eu.map(function(e){var n,t,i,o,r,a=e.scheduledAt?eC(e.scheduledAt,!0):e.timingStart?eC(e.timingStart,!0):"-",s=e.customerRebateAmount>0?e.customerVatTotal-e.customerRebateAmount-e.supplierTotal:e.customerTotal-e.supplierTotal;return{id:e.id,jobId:"J ".concat(e.number," "),type:e.type,number:e.number,invoiceNumber:(null===(n=e.invoices)||void 0===n?void 0:null===(t=n[0])||void 0===t?void 0:t.invoiceNumber)||"-",amountOutstanding:null==e?void 0:null===(i=e.invoices)||void 0===i?void 0:i.reduce(function(e,n){var t;return e+((null==n?void 0:null===(t=n.outstandingAmounts)||void 0===t?void 0:t.amount)||0)},0),ref:e.reference||"-",description:e.description||"-",service:(null===(o=e.service)||void 0===o?void 0:o.name)||"-",priority:(null===(r=e.sla)||void 0===r?void 0:r.name)||"-",location:e.location,customerNet:null==e?void 0:e.customerTotal,supplierNet:null==e?void 0:e.supplierTotal,supplier:null==e?void 0:e.supplier,tags:e.tags,revenue:s||0,scheduleDate:a,customer:null==e?void 0:e.customer,date:eC(e.createdAt),status:e.status}})},[eu]),eS=(0,s.useCallback)(function(e){e.stopPropagation();var n=(0,q.Uu)(ee);m().push("/dashboard/issues/manage".concat(n))},[ee]),eR=(0,s.useMemo)(function(){var e={};return eT.length||f.isEqual(ee,c)?{title:"No work orders",subtitleFirstLine:"You currently have no work orders set up in the system",subtitleSecondLine:"Click create work orders to get started building.",buttonText:"Create work orders",onAction:eS}:{title:"No results",subtitleFirstLine:"The filters you have applied have returned no results",subtitleSecondLine:"Please amend and try again if necessary."}},[ee,eS,c,eT]),eA=(0,i.Z)({ref:P(["admin","customer"]),service:P(["admin","customer"]),customerNet:P(["admin","customer"]),amountOutstanding:P(["admin","customer"]),supplierNet:P(["admin","supplier"]),revenue:P("admin"),supplier:P("admin"),tags:P("admin"),customer:z.includes("suppliers")&&P("admin")},R);return(0,a.jsxs)(a.Fragment,{children:[G&&(0,a.jsx)(j.h,{initialFilters:c,open:G,setFilters:en,setOpen:K,filtersVisibilityModel:v}),(0,a.jsxs)(x.Z,{spacing:2,sx:V.header,children:[(0,a.jsxs)(x.Z,{width:"100%",direction:"row",justifyContent:"space-between",children:[(0,a.jsx)(h.Z,{variant:"contained",startIcon:(0,a.jsx)(I.Z,{}),onClick:function(){return K(!0)},children:"Filters"}),(0,a.jsxs)(x.Z,{direction:"row",spacing:2,children:[!P(["supplier","tenant"])&&(0,a.jsx)(h.Z,{variant:"contained",color:"secondary",onClick:eS,children:"Create Work Order"}),!et&&(0,a.jsx)(h.Z,{startIcon:!ej&&(0,a.jsx)("img",{src:"/static/icons/csv.svg"}),disabled:ej,variant:"contained",color:"success",onClick:function(e){e.stopPropagation(),eI()},children:ej?(0,a.jsx)(y.Z,{size:20,color:"secondary"}):"Export"})]})]}),(0,a.jsxs)(b.Z,{sx:V.tableContainer,children:[(0,a.jsx)(g.Z,{ml:2,variant:"h5",sx:V.title,children:"Work Orders"}),(null==eT?void 0:eT.length)?(0,a.jsx)(_.i,{ref:er,loading:el,columns:eN,rows:eT,columnVisibilityModel:eA,meta:ed,refetch:em,autoHeight:!1,onRowClick:e_,containerHeight:"calc(100% - 52px)"}):!el&&(0,a.jsx)(Z.C,(0,i.Z)({imageSrc:"/static/icons/no_locations_found.svg"},eR))]})]})]})},V={header:{width:"100%",height:"100%"},tableContainer:{padding:"16px 0px",height:"calc(80vh - 22px)"},title:{fontWeight:600,marginBottom:"15px"}};O.propTypes={filters:d.object},O.defaultProps={filters:{assetId:null,managerId:null},columnVisibilityModel:{}}},63321:function(e,n,t){t.d(n,{y:function(){return k}});var i=t(85893),o=t(68956),r=t(26186),a=t(16551),s=t(77439),c=t(11585),u=t(16540),d=t(47568),l=t(26042),m=t(69396),v=t(828),p=t(97582),f=t(50319),h=t(7297),b=t(75063);function x(){var e=(0,h.Z)(["\n  mutation AddBankAccount($objects: [BankAccount_insert_input!]!) {\n    insert_BankAccount(objects: $objects) {\n      returning {\n        id\n        stripeId\n        accountNumber\n        routingNumber\n        bic\n        iban\n        status\n        createdAt\n      }\n    }\n  }\n"]);return x=function(){return e},e}function g(){var e=(0,h.Z)(["\n  mutation UpdateBankAccount($id: Int!, $changes: BankAccount_set_input) {\n    update_BankAccount_by_pk(pk_columns: { id: $id }, _set: $changes) {\n      id\n    }\n  }\n"]);return g=function(){return e},e}var y=(0,b.Ps)(x()),I=(0,b.Ps)(g()),j=t(42283),Z=t(79665),_=t(76600),C=t(49501),w=t(55563),N=t(58594),T=t(16310),S=(0,T.Ry)().shape({bank:(0,T.Z_)().required(),accountNumber:(0,T.Z_)().required(),bic:(0,T.Z_)().required(),iban:(0,T.Z_)().required(),routingNumber:(0,T.Z_)().required(),showInInvoice:(0,T.O7)()}),R=function(e){var n,t=e.accountId,o=e.data,r=e.refetch,a=e.toggleShow,s=(0,j.cI)({defaultValues:o,resolver:(0,Z.S)(S)}),c=s.errors,u=s.handleSubmit,h=s.register,b=(0,v.Z)((0,f.D)(y,{onCompleted:function(){r(),a()}}),1)[0],x=(0,v.Z)((0,f.D)(I,{onCompleted:function(){r(),a()}}),1)[0],g=(n=(0,d.Z)(function(e){var n;return(0,p.__generator)(this,function(i){switch(i.label){case 0:if(n={bank:e.bank,accountNumber:e.accountNumber,bic:e.bic,iban:e.iban,routingNumber:e.routingNumber,stripeId:"ba_42g2s45sh46jl46h",accountId:t,status:"active",countryId:1,currencyId:1,meta:{showInInvoice:Boolean(e.showInInvoice)}},!(null==o?void 0:o.id))return[3,2];return[4,x({variables:{id:o.id,changes:n}})];case 1:return i.sent(),[3,4];case 2:return[4,b({variables:{objects:[n]}})];case 3:i.sent(),i.label=4;case 4:return[2]}})}),function(e){return n.apply(this,arguments)}),T={errors:c,register:h};return(0,i.jsxs)(_.Z,{id:"offCanvasForm",handleSubmit:u(g),children:[(0,i.jsx)(C.Z,{label:"Bank name",children:(0,i.jsx)(w.Z,(0,m.Z)((0,l.Z)({},T),{name:"bank"}))}),(0,i.jsx)(C.Z,{label:"Account number",children:(0,i.jsx)(w.Z,(0,m.Z)((0,l.Z)({},T),{name:"accountNumber"}))}),(0,i.jsx)(C.Z,{label:"Routing number",children:(0,i.jsx)(w.Z,(0,m.Z)((0,l.Z)({},T),{name:"routingNumber"}))}),(0,i.jsx)(C.Z,{label:"BIC",children:(0,i.jsx)(w.Z,(0,m.Z)((0,l.Z)({},T),{name:"bic"}))}),(0,i.jsx)(C.Z,{label:"IBAN",children:(0,i.jsx)(w.Z,(0,m.Z)((0,l.Z)({},T),{name:"iban"}))}),(0,i.jsx)(N.Z,(0,m.Z)((0,l.Z)({},T),{data:[{id:"1",label:"Show in invoice",value:"true"}],name:"showInInvoice"}))]})},A=t(74492),k=function(e){var n=e.accountId,t=e.data,d=e.edit,l=e.refetch,m=(0,A.a)(),v=[{hidden:!0},{text:"Bank"},{text:"Account number"},{text:"Routing"},{text:"BIC"},{text:"IBAN"},{text:"Stripe ID",hidden:!0},{text:"Date Added"},{formatter:function(e){return!0===e.row.showInInvoice?"True":"False"},text:"Show In Invoice"},{formatter:o.Z,formatterData:[{context:"secondary",icon:["fas","edit"],onClick:function(e,n){return h(e,n)},tooltip:"Edit"}],text:"Actions"}],p=function(e){var n,t;return{id:e.id,bank:null==e?void 0:e.bank,accountNumber:null==e?void 0:e.accountNumber,routingNumber:null==e?void 0:e.routingNumber,bic:null==e?void 0:e.bic,iban:null==e?void 0:e.iban,stripeId:e.stripeId,date:(0,r.Z)(e.createdAt),showInInvoice:null!==(n=e.meta)&&void 0!==n&&!!n.showInInvoice&&(null===(t=e.meta)||void 0===t?void 0:t.showInInvoice),actions:""}},f=function(e){e.stopPropagation(),m.show({content:(0,i.jsx)(R,{accountId:n,refetch:l,toggleShow:m.close}),title:"Add Bank Account"})},h=function(e,t){e.stopPropagation(),m.show({content:(0,i.jsx)(R,{accountId:n,data:t,refetch:l,toggleShow:m.close}),title:"Edit Bank Account"})},b=function(){return(0,i.jsx)(a.Z,{children:(0,i.jsx)(s.Z,{context:"secondary",content:"Add",onClick:f,size:"sm"})})};return(0,i.jsx)(c.Z,{open:!0,title:"Bank Accounts",toolbar:(void 0===d||d)&&(0,i.jsx)(b,{}),children:(0,i.jsx)(u.Z,{columns:v,rows:(void 0===t?[]:t).map(function(e){return p(e)})})})}},31453:function(e,n,t){t.d(n,{r:function(){return i}});var i=[{text:"All work orders",value:null,label:"All work orders"},{text:"All outstanding invoices",value:"0-",label:"All outstanding invoices"},{text:"1 - 30",value:"1-30",label:"1 - 30"},{text:"31 - 60",value:"31-60",label:"31 - 60"},{text:"61 - 90",value:"61-90",label:"61 - 90"},{text:"> 90",value:"90-",label:"> 90"}]},39453:function(e,n,t){t.d(n,{b:function(){return nx}});var i=t(47568),o=t(97582),r=t(85893),a=t(67294),s=t(45697),c=t(11163),u=t(6812),d=t(16825),l=t(78289),m=t(11082),v=t(16551),p=t(77439),f=t(9270),h=t(62140),b=t(11585),x=t(16540),g=t(63321),y=t(7297),I=t(10367),j=t(86036),Z=t(55377),_=t(11587),C=t(31113),w=t(97637),N=t(26042),T=t(69396),S=t(828),R=t(50319),A=t(22181),k=t(42283),$=t(76600),D=t(28497),q=t(49501),P=t(55563),F=function(e){var n,t=e.accountId,a=e.meta,s=e.refetch,c=e.toggleShow,u=(0,N.Z)({},null==a?void 0:a.finance),d=(0,k.cI)({defaultValues:{creditLimit:u.creditLimit||0,creditRating:u.creditRating||0}}),l=d.errors,m=d.handleSubmit,v=d.register,p=(0,S.Z)((0,R.D)(A.Wn),1)[0],f=(n=(0,i.Z)(function(e){return(0,o.__generator)(this,function(n){return p({variables:{customerId:t,customer:h(e)}}).then(function(){s(),c()}),[2]})}),function(e){return n.apply(this,arguments)}),h=function(e){var n={};return n.meta=(0,N.Z)({},a),n.meta.finance=u||{},n.meta.finance.creditLimit=Number(e.creditLimit),n.meta.finance.creditRating=Number(e.creditRating),n},b={errors:l,register:v};return(0,r.jsxs)($.Z,{id:"offCanvasForm",handleSubmit:m(f),children:[(0,r.jsx)(D.Z,(0,T.Z)((0,N.Z)({},b),{name:"creditLimit",label:"Credit Limit"})),(0,r.jsx)(q.Z,{label:"Credit Rating",children:(0,r.jsx)(P.Z,(0,T.Z)((0,N.Z)({},b),{name:"creditRating",type:"number"}))})]})};F.propTypes={finance:s.object.isRequired,refetch:s.func.isRequired,toggleShow:s.func.isRequired};var E=function(e){var n=e.percent,t=e.breakPoints;return((!t||t.length<2)&&(t=[70,90]),n<=t[0])?"success":n<=t[1]?"warning":"danger"},L=t(19504);function W(){var e=(0,y.Z)(["\n  margin-bottom: 0;\n"]);return W=function(){return e},e}var M=function(e){var n,t,i=e.accountId,o=e.edit,a=e.meta,s=e.offCanvas,c=e.customerBalance,u=e.refetch,d=(null==a?void 0:a.finance)||{};n=!(c>=0)&&(null==d?void 0:d.creditLimit)?-1*(0,L.l)(c/(null==d?void 0:d.creditLimit)*100,0):0;var l=function(){s.show({title:"Edit Credit Details",content:(0,r.jsx)(F,{accountId:i,meta:a,refetch:u,toggleShow:s.close})})};return(0,r.jsxs)(w.G,{carousel:!1,details:!0,entity:"CreditReport",entityId:null==d?void 0:d.id,summary:"Credit Report",children:[(0,r.jsx)(j.Z,{content:"Balance",text:(0,m.Z)(null!=c?c:0)}),(0,r.jsx)(j.Z,{content:"Credit Limit",text:(0,r.jsxs)(r.Fragment,{children:["".concat((0,m.Z)(null!==(t=null==d?void 0:d.creditLimit)&&void 0!==t?t:0)," "),(0,r.jsx)(B,{size:"sm",content:"".concat(n,"%"),context:E({percent:n})})]})}),(0,r.jsx)(j.Z,{content:"Credit Rating",text:(null==d?void 0:d.creditRating)||0}),o&&(0,r.jsx)(C.H,{content:"Edit",handleClick:l}),(0,r.jsx)(Z.Z,{size:"sm"})]})};M.defaultProps={edit:!0};var B=(0,I.ZP)(_.Z).withConfig({displayName:"creditReport__StyledBadge",componentId:"sc-2324236e-0"})(W()),J=t(66252),U=t(73359),Y=t(57460),O=t.n(Y),V=t(48795),X=t(74944),z=t(4438),Q=t(86532),G=t(22797),K=t(38895),H=t(15861),ee=t(51233),en=t(84808),et=t(98456),ei=t(45451),eo=t(40876),er=t(30381),ea=t.n(er),es=t(50108),ec=t(1691),eu=t(11057),ed=t(53767),el=t(59505),em=t(19512),ev=function(e){var n,t,i,o,s=e.accountEntryId,c=e.close,l=(0,em.D)(),m=(0,ed.q)(),v=null===(n=m.admin)||void 0===n?void 0:null===(t=n.jobSetting)||void 0===t?void 0:t.jobNumberPrefix,p=null===(i=m.admin)||void 0===i?void 0:null===(o=i.jobSetting)||void 0===o?void 0:o.jobNumberSuffix,f=(0,(0,X.x)().hasRole)("admin"),h=(0,S.Z)((0,R.D)(d.Y8,{refetchQueries:["GetAccountEntries"],onCompleted:function(){l.show({content:"Account Entry was successfully deleted",severity:"success"}),c&&c()},onError:function(e){l.show({content:"Error: ".concat(e.message),severity:"error"})}}),2),b=h[0],x=h[1].loading,g=(0,u.a)(d.L2,{variables:{accountEntryId:s}}),y=g.data,I=(void 0===y?{accountEntry:{}}:y).accountEntry,j=g.loading,Z=(0,u.a)(d.to,{variables:{accountEntryId:I.id,skip:!I.id||!["paymentReceipt","creditNote"].includes(I.type)}}),_=Z.data,C=(void 0===_?{reconciliations:[]}:_).reconciliations,w=Z.loading,N=(0,u.a)(d.yz,{variables:{accountEntryId:I.id,skip:!I.id||!z.YK.includes(I.type)}}),T=N.data,A=(void 0===T?{invoices:[]}:T).invoices,k=N.loading,$=(0,a.useMemo)(function(){return C.map(function(e){var n,t,i,o,r,a=null===(n=e.accountEntryInvoice)||void 0===n?void 0:null===(t=n.invoices)||void 0===t?void 0:t[0];return z.YK.includes(e.type)?{id:e.id,jobNumber:null,invoiceNumber:e.accountEntryInvoice.invoiceNumber,invoiceType:e.accountEntryInvoice.type,date:ea()(e.createdAt).format("YYYY-MM-DD"),reconciledAmount:(0,es.T)(e.amount),jobType:"ppm",jobId:null}:{id:e.id,jobNumber:null==a?void 0:null===(i=a.job)||void 0===i?void 0:i.number,invoiceNumber:null==a?void 0:a.invoiceNumber,invoiceType:null==a?void 0:a.invoiceType,date:ea()(e.createdAt).format("YYYY-MM-DD"),reconciledAmount:(0,es.T)(e.amount),jobType:null==a?void 0:null===(o=a.job)||void 0===o?void 0:o.type,jobId:null==a?void 0:null===(r=a.job)||void 0===r?void 0:r.id}})},[C]),D=(0,a.useMemo)(function(){return A.map(function(e){var n,t,i,o;return{id:null==e?void 0:null===(n=e.Job)||void 0===n?void 0:n.id,number:null==e?void 0:null===(t=e.Job)||void 0===t?void 0:t.number,status:null==e?void 0:null===(i=e.Job)||void 0===i?void 0:i.status,invoiceNumber:null==e?void 0:e.invoiceNumber,jobType:null==e?void 0:null===(o=e.Job)||void 0===o?void 0:o.type}})},[A]),q=function(e){e.stopPropagation(),b({variables:{id:I.id}})};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(en.Z,{sx:{zIndex:1e5},open:j||x,children:(0,r.jsx)(et.Z,{color:"secondary"})}),(0,r.jsxs)(Q.Z,{defaultExpanded:!0,children:[(0,r.jsx)(K.Z,{expandIcon:(0,r.jsx)(eo.Z,{}),children:"Account Entry Details"}),(0,r.jsx)(G.Z,{children:(0,r.jsxs)(ee.Z,{spacing:1,children:[(0,r.jsxs)(ee.Z,{children:[(0,r.jsx)(H.Z,{variant:"subtitle2",children:"Date"}),(0,r.jsx)(H.Z,{children:ea()(I.createdAt).format("YYYY-MM-DD")})]}),(0,r.jsxs)(ee.Z,{children:[(0,r.jsx)(H.Z,{variant:"subtitle2",children:"Type"}),(0,r.jsx)(H.Z,{children:I.type})]}),(0,r.jsxs)(ee.Z,{children:[(0,r.jsx)(H.Z,{variant:"subtitle2",children:"Reference"}),(0,r.jsx)(H.Z,{children:I.reference||"-"})]}),(0,r.jsxs)(ee.Z,{children:[(0,r.jsx)(H.Z,{variant:"subtitle2",children:"Comment"}),(0,r.jsx)(H.Z,{children:I.comment||"-"})]}),(0,r.jsxs)(ee.Z,{children:[(0,r.jsx)(H.Z,{variant:"subtitle2",children:"Debit"}),(0,r.jsx)(H.Z,{children:(0,es.T)(I.debit)})]}),(0,r.jsxs)(ee.Z,{children:[(0,r.jsx)(H.Z,{variant:"subtitle2",children:"Credit"}),(0,r.jsx)(H.Z,{children:(0,es.T)(I.credit)})]})]})})]}),["paymentReceipt","creditNote"].includes(I.type)&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(Q.Z,{defaultExpanded:!0,children:[(0,r.jsx)(K.Z,{expandIcon:(0,r.jsx)(eo.Z,{}),children:"Related Invoices"}),(0,r.jsx)(G.Z,{children:(0,r.jsx)(ei.i,{loading:w,columns:[{flex:1,sortable:!1,headerName:"Number",field:"jobNumber",renderCell:function(e){var n=e.row;return z.YK.includes(n.invoiceType)?"PM ".concat(n.invoiceNumber):(0,r.jsx)(V.D,{id:n.jobId,number:n.jobNumber,invoiceNumber:n.invoiceNumber,numberPrefix:v,numberSuffix:p,openCanvas:!0,type:n.jobType})}},{flex:1,sortable:!1,headerName:"Date",field:"date"},{flex:1,sortable:!1,headerName:"Reconciled Amount",field:"reconciledAmount"}],rows:$})})]}),f&&(0,r.jsx)(eu.Z,{fullWidth:!0,variant:"contained",color:"danger",sx:{marginTop:"16px"},onClick:q,children:"Delete"}),f&&C.length>0&&(0,r.jsx)(ec.Z,{variant:"filled",severity:"info",sx:{marginTop:"16px"},children:"Deleting this receipt will potentially remove other reconciled entries."})]}),z.YK.includes(I.type)&&(0,r.jsxs)(Q.Z,{defaultExpanded:!0,children:[(0,r.jsx)(K.Z,{expandIcon:(0,r.jsx)(eo.Z,{}),children:"Related Jobs"}),(0,r.jsx)(G.Z,{children:(0,r.jsx)(ei.i,{loading:k,columns:[{flex:1,sortable:!1,headerName:"Number",field:"number",renderCell:function(e){var n=e.row;return(0,r.jsx)(V.D,{id:n.id,number:n.number,invoiceNumber:n.invoiceNumber,numberPrefix:v,numberSuffix:p,openCanvas:!0,type:n.jobType,close:function(){c&&c()}})}},{flex:1,sortable:!1,headerName:"Status",field:"status",renderCell:function(e){var n=e.row;return n.status?(0,r.jsx)(el.B,{value:n.status}):""}}],rows:D})})]})]})};ev.propTypes={accountEntryId:s.number,close:s.func},ev.defaultProps={};var ep=t(29815),ef=t(74297),eh=t(26186),eb=t(64277),ex=function(e,n){var t=n||{},i=t.numberPrefix,o=void 0===i?"":i,r=t.numberSuffix,a=void 0===r?"":r;return e.map(function(e){var n,t,i,r,s,c,u,d,l,m,v,p,f,h,b,x,g=(null==e?void 0:null===(n=e.reconciliations)||void 0===n?void 0:null===(t=n.aggregate)||void 0===t?void 0:null===(i=t.sum)||void 0===i?void 0:i.amount)||null,y=null===(r=e.invoices)||void 0===r?void 0:r[0],I=null;return["invoice","proformaInvoice"].includes(e.type)?I="".concat((0,eb.y)(null==y?void 0:null===(b=y.Job)||void 0===b?void 0:b.type)," ").concat(o," ").concat(null==y?void 0:null===(x=y.Job)||void 0===x?void 0:x.number," ").concat(a," / ").concat(null==y?void 0:y.invoiceNumber):z.YK.includes(e.type)&&(I="PM / ".concat((null==y?void 0:y.invoiceNumber)||"")),{itemType:(0,ef.Z)(e.type),invoice:I,reference:(null===(s=e.meta)||void 0===s?void 0:s.paymentReference)||(null==y?void 0:null===(c=y.Job)||void 0===c?void 0:c.reference),date:(0,eh.Z)(e.createdAt),daysOutstanding:null==e?void 0:e.outstandingdays,status:null==y?void 0:null===(u=y.Job)||void 0===u?void 0:u.status,service:null==y?void 0:null===(d=y.Job)||void 0===d?void 0:null===(l=d.service)||void 0===l?void 0:l.name,address:null==y?void 0:null===(m=y.Job)||void 0===m?void 0:null===(v=m.location)||void 0===v?void 0:v.name,sublocation:null==y?void 0:null===(p=y.Job)||void 0===p?void 0:null===(f=p.sublocation)||void 0===f?void 0:f.name,debit:e.debit,credit:e.credit,balance:e.balance,reconciledAmount:null!=g?g:0,amountOutstanding:e.outstandingAmount,paymentStatus:e.paymentStatus,comment:null===(h=e.meta)||void 0===h?void 0:h.comment}})},eg=function(e){var n=e.accountId,t=e.from,i=void 0===t?null:t,o=e.jobNumber,r=e.locationId,a=e.outstandingLevel,s=e.to,c=void 0===s?null:s,u=e.type,d=e.invoicesForJobOnly,l={},m={},v=[],p=[],f=[];return r&&(v=[{_or:[{locationId:{_eq:r}},{PaymentReconciliations:{locationId:{_eq:r}}}]}]),u&&(l.type={_in:(0,ep.Z)(u).concat(["ppmInvoice","invoice"])},l.paymentStatus={_in:(0,ep.Z)(u)}),n&&(l.accountId={_eq:n}),a&&(l.outstandingdays={_gte:a.split("-")[0]||null,_lte:a.split("-")[1]||null}),(c||i)&&(f=[{_and:[{_or:[{_and:[{createdAt:{_gte:i}},{createdAt:{_lte:c}}]}]}]}]),o&&(p=void 0!==d&&d?[{Invoices:{Job:{number:{_ilike:o}}}}]:[{_or:[{Invoices:{invoiceNumber:{_eq:o}}},{Invoices:{Job:{number:{_ilike:o}}}},{PaymentReconciliations:{InvoiceEntry:{Invoices:{invoiceNumber:{_eq:o}}}}},{PaymentReconciliations:{InvoiceEntry:{Invoices:{Job:{number:{_ilike:o}}}}}}]}]),(v.length>0||p.length>0||f.length>0)&&(m={_and:(0,ep.Z)(v).concat((0,ep.Z)(p),(0,ep.Z)(f))}),(0,N.Z)({},l,m)},ey=t(62047),eI=t(87336),ej=t(12632),eZ=t(16166),e_=function(e){var n=e.itemType,t=e.paymentStatus;return"paymentReceipt"===n?"black":"creditNote"===n?"dark":"paid"===t?"success":"partial"===t?"pink":"warning"};function eC(){var e=(0,y.Z)(["\n  background-color: ",";\n"]);return eC=function(){return e},e}var ew=function(e){var n=e.adminId,t=e.accountId,i=e.locationId,o=e.onSendEntities;e.toggleShow;var s=(0,a.useState)(!1),l=s[0],v=s[1],p=function(e,n){var t=e.id;B(M.map(function(e){return e.id===t&&(e.assigned=n),e}))},f=[{hidden:!0},{hidden:!0},{text:"Number",formatter:function(e){var n,t=e.row;return z.YK.includes(t.type)?"PM ".concat(t.invoiceNumber):(0,r.jsx)(V.D,{id:t.jobId,number:t.number,invoiceNumber:null===(n=t.invoice)||void 0===n?void 0:n.invoiceNumber,type:t.jobType})}},{formatter:function(e){var n=e.row,t=e.row.itemType;return(0,r.jsx)(eN,{content:t,row:n,size:"sm"})},text:"Type"},{hidden:!0},{hidden:!0},{hidden:!0},{text:"Amount Outstanding",formatter:function(e){var n=e.row;return"invoice"===n.itemType||"proformaInvoice"===n.itemType?(0,m.Z)(n.outstandingAmount):"-"}},{text:"Status",formatter:function(e){var n=e.row;return n.status?(0,r.jsx)(eZ.B,{value:n.status}):""}},{hidden:!0},{hidden:!0},{formatter:function(e){var n,t,i,o,a=e.row;return(0,r.jsx)(ey.Z,{context:"secondary",size:"sm",onToggle:function(e){return p(a,e)},toggled:a.assigned||(null===(n=a.meta)||void 0===n?void 0:n.xeroInvoiceId)||(null===(t=a.meta)||void 0===t?void 0:t.xeroCreditNoteId),disabled:(null===(i=a.meta)||void 0===i?void 0:i.xeroInvoiceId)||(null===(o=a.meta)||void 0===o?void 0:o.xeroCreditNoteId)})},text:(0,r.jsx)(ey.Z,{context:"secondary",size:"sm",onToggle:function(e){return h(e)}})}],h=function(e){B(J(e))},b=function(){v(!1)},x=function(e){e.preventDefault(),v(!0),o(M.filter(function(e){var n,t;return e.assigned&&!((null===(n=e.meta)||void 0===n?void 0:n.xeroInvoiceId)||(null===(t=e.meta)||void 0===t?void 0:t.xeroCreditNoteId))}).map(function(e){return"creditNote"===e.itemType?{id:e.id,entity:e.itemType}:{entity:e.itemType,invoiceType:e.invoice.invoiceType||null,invoiceId:e.id||null}}),b)},g=(0,c.useRouter)().query,y={endDate:g.endDate&&new Date(g.endDate),outstandingLevel:g.outstandingLevel,startDate:g.startDate&&new Date(g.startDate),type:["ppmInvoice","proformaInvoice","partial","paid","unpaid"]},I=(0,a.useState)(y)[0],j=I.endDate,Z=I.outstandingLevel,_=I.startDate,C=I.type,w=(0,ej.x)({filters:I}),S=w.initialData,R=w.ref,A=(0,T.Z)((0,N.Z)({},S),{limit:25}),k=(0,u.a)(d.BH,{fetchPolicy:"no-cache",variables:(0,T.Z)((0,N.Z)({},A),{where:(0,T.Z)((0,N.Z)({},eg({outstandingLevel:Z,adminId:n,accountId:t,to:j,from:_,locationId:i,type:C})),{_or:[{_and:[{meta:{_is_null:!1}},{_not:{meta:{_has_key:"xeroInvoiceId"}}},{_not:{meta:{_has_key:"xeroCreditNoteId"}}}]},{meta:{_is_null:!0}}]}),locationId:i})}),D=k.data,q=void 0===D?{accountEntries:[],meta:{aggregate:{totalCount:0,debitTotal:{debit:0},creditTotal:{credit:0},balance:{balance:0}}}}:D,P=q.accountEntries,F=q.meta,E=k.loading,L=k.refetch,W=(0,a.useState)([]),M=W[0],B=W[1],J=(0,a.useCallback)(function(e){return P.map(function(n){var t,i,o,r,a,s,c,u,d,l,m,v,p,f,h;return{id:n.id,jobId:null==n?void 0:null===(t=n.invoices)||void 0===t?void 0:null===(i=t[0])||void 0===i?void 0:null===(o=i.Job)||void 0===o?void 0:o.id,number:null==n?void 0:null===(r=n.invoices)||void 0===r?void 0:null===(a=r[0])||void 0===a?void 0:null===(s=a.Job)||void 0===s?void 0:s.number,itemType:n.type,jobType:null==n?void 0:null===(c=n.invoices)||void 0===c?void 0:null===(u=c[0])||void 0===u?void 0:null===(d=u.Job)||void 0===d?void 0:d.type,invoiceNumber:null==n?void 0:null===(l=n.invoices)||void 0===l?void 0:null===(m=l[0])||void 0===m?void 0:m.invoiceNumber,invoice:(null==n?void 0:n.invoices)?null==n?void 0:null===(v=n.invoices)||void 0===v?void 0:v[0]:null,outstandingAmount:n.outstandingAmount,status:null==n?void 0:null===(p=n.invoices)||void 0===p?void 0:null===(f=p[0])||void 0===f?void 0:null===(h=f.Job)||void 0===h?void 0:h.status,paymentStatus:n.paymentStatus,meta:null==n?void 0:n.meta,assigned:e,actions:""}})},[P]);return(0,a.useEffect)(function(){B(J(!1))},[J,E]),(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(en.Z,{sx:{color:"#fff",zIndex:function(e){return e.zIndex.drawer+1}},open:l,children:(0,r.jsx)(et.Z,{color:"inherit"})}),(0,r.jsx)($.Z,{id:"offCanvasForm",handleSubmit:x,children:(0,r.jsx)(eI.t,{columns:f,loading:E,meta:F,ref:R,refetch:L,rows:M,xeroPageSize:25})})]})};ew.propTypes={adminId:s.number.isRequired,accountId:s.number.isRequired,locationId:s.number,toggleShow:s.func,onSendEntities:s.func.isRequired};var eN=(0,I.ZP)(_.Z).withConfig({displayName:"syncXero__StyledBadge",componentId:"sc-657205a0-0"})(eC(),function(e){return e_(e.row)}),eT=t(93753),eS=t(9367),eR=t(31249),eA=t(14924),ek=t(96486),e$=function(e){var n,t,i,o=e.accountId,r=e.locationId,a=e.jobId,s=[];s.push(r?{locationId:{_eq:r}}:{}),s.push(o?{accountId:{_eq:o}}:{}),s.push(a?{Invoices:{entityId:{_eq:a}}}:{}),s.push({type:{_in:["proformaInvoice","customerPpmInvoice","supplierPpmInvoice","invoice"]},paymentStatus:{_in:["unpaid","partial"]}});var c=s.filter(function(e){return!ek.isEmpty(e)});return(0,N.Z)({},c.length>0&&{_and:c})},eD=t(87918),eq=t(86886),eP=t(50135),eF=t(33754),eE=t(87109),eL=t(72852),eW=t(50480),eM=t(70452),eB=t(93946),eJ=t(16310),eU=(0,eJ.Ry)().shape({dateReceived:(0,eJ.hT)().required("Date Received is required").typeError("Date Received is required"),amount:(0,eJ.Rx)().min(0).required("Amount Received is required"),reason:(0,eJ.Z_)().nullable()}),eY=function(e){var n,t,i,o,s=e.accountId,c=e.locationId,l=e.jobId,m=e.refetch,v=e.close,p=(0,em.D)(),f=(0,ed.q)(),h=null===(n=f.admin)||void 0===n?void 0:null===(t=n.jobSetting)||void 0===t?void 0:t.jobNumberPrefix,b=null===(i=f.admin)||void 0===i?void 0:null===(o=i.jobSetting)||void 0===o?void 0:o.jobNumberSuffix,x=(0,ej.x)({filters:null}),g=x.initialData,y=x.ref,I=(0,a.useState)(null),j=I[0],Z=I[1],_=(0,a.useState)(new Date),C=_[0],w=_[1],A=(0,a.useState)(0),k=A[0],$=A[1],D=(0,a.useState)(""),q=D[0],P=D[1],F=(0,a.useState)(!1),E=F[0],W=F[1],M=(0,a.useState)([]),B=M[0],J=M[1],U=(0,a.useState)(0),Y=U[0],O=U[1],X=(0,a.useMemo)(function(){return e$({accountId:s,locationId:c,jobId:l})},[s,l,c]),z=(0,u.a)(d.v8,{variables:{limit:g.limit,offset:g.offset,accountId:s,locationId:c,orderBy:g.orderBy,where:X},onCompleted:function(e){var n,t=null==e?void 0:null===(n=e.accountEntries)||void 0===n?void 0:n.map(function(e,n){var t,i,o,r,a=null===(t=e.invoices)||void 0===t?void 0:t[0];return{index:n,id:e.id,type:e.type,jobId:null==a?void 0:null===(i=a.Job)||void 0===i?void 0:i.id,locationId:e.locationId,jobNumber:null==a?void 0:null===(o=a.Job)||void 0===o?void 0:o.number,jobType:null==a?void 0:null===(r=a.Job)||void 0===r?void 0:r.type,invoiceNumber:e.invoiceNumber,date:ea()(e.createdAt).format("YYYY-MM-DD"),daysOutstanding:e.outstandingdays,outstandingAmount:e.outstandingAmount,amount:0,invoiceId:null==a?void 0:a.id,meta:e.meta}});J(t||[])}}),Q=z.data,G=(void 0===Q?{meta:{aggregate:{totalCount:0,debitTotal:{debit:0},creditTotal:{credit:0}}}}:Q).meta,K=z.loading,H=z.refetch,eo=(0,S.Z)((0,R.D)(d.DI,{refetchQueries:["GetAccountEntries","GetJob"],onCompleted:function(){p.show({severity:"success",content:"Credit note was added successfully."}),m&&m(),v&&v()},onError:function(e){p.show({severity:"error",content:"Error: ".concat(e.message)})}}),2),er=eo[0],ec=eo[1].loading,eu=function(e){e.preventDefault();try{eU.validateSync({dateReceived:C,amount:k,reason:q},{abortEarly:!1})}catch(n){return Z(n.inner.reduce(function(e,n){var t=n.path,i=n.message;return(0,T.Z)((0,N.Z)({},e),(0,eA.Z)({},t,i))},{}))}if(Number(Y).toFixed(2)!==Number(k).toFixed(2))return p.show({severity:"error",content:"Error: The sum of the reconciled amounts does not match the amount received."});er({variables:{data:{dateReceived:C,amountReceived:k,reason:q,accountId:s,payments:B.filter(function(e){return e.amount>0}).map(function(e){var n;return{id:e.id,amount:e.amount}})}}})},el=(0,a.useCallback)(function(e){var n=Number(e.target.value);$(function(){if(!E)return e.target.value;var t=n,i=0,o=B.map(function(e){var n=Math.min(e.outstandingAmount,t);return i+=(0,L.l)(n,2),t-=(0,L.l)(n,2),(0,T.Z)((0,N.Z)({},e),{amount:(0,L.l)(n,2)})});return O((0,L.l)(i,2)),J(o),n})},[E,B]),ev=(0,a.useCallback)(function(e,n){W(function(){if(!n)return n;var e=k,t=0,i=B.map(function(n){var i=Math.min(n.outstandingAmount,e);return t+=(0,L.l)(i,2),e-=(0,L.l)(i,2),(0,T.Z)((0,N.Z)({},n),{amount:(0,L.l)(i,2)})});return O((0,L.l)(t,2)),J(i),n})},[k,B]),ep=(0,a.useCallback)(function(e,n){J(function(t){var i=0,o=t.map(function(t){return t.id===e?(i+=(0,L.l)(Number(n),2),(0,T.Z)((0,N.Z)({},t),{amount:n})):(i+=(0,L.l)(Number(t.amount),2),(0,N.Z)({},t))});return O(i),o})},[J]),ef=(0,a.useMemo)(function(){return[{flex:1,minWidth:120,sortable:!1,headerName:"Number",field:"number",renderCell:function(e){var n=e.row;return["customerPpmInvoice","supplierPpmInvoice"].includes(n.type)?"PM ".concat(n.invoiceNumber):(0,r.jsx)(V.D,{id:n.jobId,number:n.jobNumber,invoiceNumber:n.invoiceNumber,numberPrefix:h,numberSuffix:b,openCanvas:!0,type:n.jobType})}},{flex:1,minWidth:120,sortable:!0,sortName:"createdAt",headerName:"Date",field:"date"},{flex:1,minWidth:120,sortable:!0,sortName:"outstandingdays",headerName:"Days Outstanding",field:"daysOutstanding"},{flex:1,minWidth:120,sortable:!0,sortName:"outstandingAmount",headerName:"Amount Outstanding",field:"outstandingAmount",renderCell:function(e){var n=e.row;return(0,es.T)(n.outstandingAmount)}},{flex:1,minWidth:250,sortable:!1,headerName:"Reconciled Amount",field:"amount",renderCell:function(e){var n=e.row;return(0,r.jsxs)(ee.Z,{direction:"row",children:[(0,r.jsx)(eP.Z,{fullWidth:!0,variant:"outlined",color:"secondary",size:"small",type:"number",value:n.amount,onChange:function(e){return ep(n.id,e.target.value)},inputProps:{min:0,step:.01},InputProps:{startAdornment:(0,r.jsx)(eE.Z,{position:"start",children:"\xa3"})}}),(0,r.jsx)(eB.Z,{onClick:function(){return ep(n.id,n.outstandingAmount)},children:(0,r.jsx)(eM.Z,{})})]})}}]},[ep,h,b]);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(en.Z,{sx:{zIndex:1e5},open:ec,children:(0,r.jsx)(et.Z,{color:"secondary"})}),(0,r.jsx)("form",{id:"offCanvasForm",onSubmit:eu,children:(0,r.jsxs)(ee.Z,{width:"100%",children:[(0,r.jsxs)(eq.ZP,{container:!0,columnSpacing:2,rowSpacing:2,children:[(0,r.jsx)(eq.ZP,{item:!0,xs:6,children:(0,r.jsx)(eF.M,{inputFormat:"DD/MM/YYYY",value:C,onChange:function(e){return w(e)},label:"Date Received",renderInput:function(e){return(0,r.jsx)(eP.Z,(0,T.Z)((0,N.Z)({},e),{fullWidth:!0,variant:"outlined",color:"secondary",error:!!(null==j?void 0:j.dateReceived),helperText:null==j?void 0:j.dateReceived}))}})}),(0,r.jsx)(eq.ZP,{item:!0,xs:6,children:(0,r.jsx)(eP.Z,{fullWidth:!0,color:"secondary",type:"number",label:"Amount",value:k,onChange:el,inputProps:{min:0,step:.01},InputProps:{startAdornment:(0,r.jsx)(eE.Z,{position:"start",children:"\xa3"})},error:!!(null==j?void 0:j.amount),helperText:null==j?void 0:j.amount})}),(0,r.jsx)(eq.ZP,{item:!0,xs:12,children:(0,r.jsx)(eP.Z,{multiline:!0,rows:4,label:"Reason",variant:"filled",color:"secondary",value:q,onChange:function(e){return P(e.target.value)},sx:{width:"50%"},error:!!(null==j?void 0:j.reason),helperText:null==j?void 0:j.reason})}),(0,r.jsx)(eq.ZP,{item:!0,xs:6,children:(0,r.jsx)(eW.Z,{control:(0,r.jsx)(eL.Z,{checked:E,onChange:ev,color:"success"}),label:"Auto Reconcile"})})]}),(0,r.jsx)(ei.i,{columns:ef,loading:K,history:!1,meta:G,ref:y,refetch:H,rows:B}),(0,r.jsx)(ee.Z,{width:"100%",direction:"row",justifyContent:"flex-end",children:(0,r.jsx)(eD.Z,{label:"Sum: ".concat((0,es.T)(Y)),color:Number(Y).toFixed(2)===Number(k).toFixed(2)?"success":"danger"})})]})})]})};eY.propTypes={type:(0,s.oneOf)(["customer","supplier"]).isRequired,accountId:s.number.isRequired,locationId:s.number,jobId:s.number,refetch:s.func.isRequired,close:s.func.isRequired};var eO=t(16605),eV=t(82725),eX=t(1341),ez=t(74492),eQ=t(21830),eG=t(67720),eK=function(e){var n=e.creditNote,t=e.paymentReceipt,i=e.proformaInvoice,o=e.unpaid,r=e.partiallyPaid,a=e.paid,s=[];return(n&&s.push("creditNote"),t&&s.push("paymentReceipt"),i&&s.push("proformaInvoice"),o&&s.push("unpaid"),r&&s.push("partial"),a&&s.push("paid"),0===s.length)?{type:{_in:[]},paymentStatus:{_in:[]}}:{type:{_in:(0,ep.Z)(s).concat(["customerPpmInvoice","supplierPpmInvoice","invoice"])},paymentStatus:{_in:(0,ep.Z)(s)}}},eH=function(e){var n,t,i,o,r,a,s=e.accountId,c=e.locationId,u=e.startDate,d=e.endDate,l=e.invoiceNumber,m=e.outstandingLevel,v=e.type,p=[];p.push(c?{_or:[{locationId:{_eq:c}},{PaymentReconciliations:{locationId:{_eq:c}}}]}:{}),p.push(s?{accountId:{_eq:s}}:{}),p.push(eK(v)),p.push(m?{outstandingdays:{_gte:m.split("-")[0]||null,_lte:m.split("-")[1]||null}}:{}),p.push(u||d?{_and:[{_or:[{_and:[{createdAt:{_gte:u}},{createdAt:{_lte:d}}]}]}]}:{}),p.push(l?{_or:[{Invoices:{invoiceNumber:{_ilike:"%".concat(l,"%")}}},{Invoices:{Job:{number:{_ilike:"%".concat(l,"%")}}}},{PaymentReconciliations:{InvoiceEntry:{Invoices:{invoiceNumber:{_ilike:"%".concat(l,"%")}}}}},{PaymentReconciliations:{InvoiceEntry:{Invoices:{Job:{number:{_ilike:"%".concat(l,"%")}}}}}}]}:{});var f=p.filter(function(e){return!ek.isEmpty(e)});return(0,N.Z)({},f.length>0&&{_and:f})},e0=t(31453),e1=t(91830),e2=t(61730),e6=eL.Z,e3=function(e){var n=e.control,t=e.setFilters,i=e.handleSubmit,o=(0,e2.Z)("(max-width:800px)"),a=function(e){t({startDate:e.startDate,endDate:e.endDate,invoiceNumber:e.invoiceNumber,outstandingLevel:e.outstandingLevel,creditNote:e.creditNote,paymentReceipt:e.paymentReceipt,proformaInvoice:e.proformaInvoice,unpaid:e.unpaid,partiallyPaid:e.partiallyPaid,paid:e.paid})};return(0,r.jsx)("form",{onSubmit:i(a),children:(0,r.jsxs)(ee.Z,{width:"100%",spacing:1,children:[(0,r.jsxs)(ee.Z,{direction:o?"column":"row",alignItems:"center",width:"100%",spacing:2,children:[(0,r.jsx)(k.Qr,{name:"startDate",control:n,render:function(e){return(0,r.jsx)(eF.M,(0,T.Z)((0,N.Z)({},e),{label:"Start date",renderInput:function(e){return(0,r.jsx)(eP.Z,(0,T.Z)((0,N.Z)({},e),{fullWidth:!0,variant:"outlined",color:"secondary"}))}}))}}),(0,r.jsx)(k.Qr,{name:"endDate",control:n,render:function(e){return(0,r.jsx)(eF.M,(0,T.Z)((0,N.Z)({},e),{label:"End date",renderInput:function(e){return(0,r.jsx)(eP.Z,(0,T.Z)((0,N.Z)({},e),{fullWidth:!0,variant:"outlined",color:"secondary"}))}}))}}),(0,r.jsx)(k.Qr,{name:"invoiceNumber",control:n,render:function(e){return(0,r.jsx)(eP.Z,(0,T.Z)((0,N.Z)({},e),{fullWidth:!0,label:"Id / Invoice",variant:"outlined",color:"secondary"}))}}),(0,r.jsx)(k.Qr,{name:"outstandingLevel",control:n,render:function(e){var n=e.value,t=e.onChange;return(0,r.jsx)(e1.P,{label:"Outstanding Level",value:n,onChange:t,options:e0.r,formControl:{fullWidth:!0,error:!1,helperText:""},selectProps:{fullWidth:!0,variant:"outlined",color:"secondary"}})}}),(0,r.jsx)(eu.Z,{variant:"contained",color:"secondary",type:"submit",size:"medium",sx:{height:"36px",minWidth:"auto",width:"100%",maxWidth:"120px"},children:"Filter"})]}),(0,r.jsxs)(ee.Z,{direction:"row",width:"100%",justifyContent:"space-between",flexWrap:"wrap",children:[(0,r.jsx)(eW.Z,{control:(0,r.jsx)(k.Qr,{name:"creditNote",control:n,render:function(e){var n=e.value,t=e.onChange;return(0,r.jsx)(e6,{checked:n,onChange:function(e,n){return t(n)},color:"dark"})}}),label:"Credit Note"}),(0,r.jsx)(eW.Z,{control:(0,r.jsx)(k.Qr,{name:"paymentReceipt",control:n,render:function(e){var n=e.value,t=e.onChange;return(0,r.jsx)(e6,{checked:n,onChange:function(e,n){return t(n)},color:"black"})}}),label:"Payment"}),(0,r.jsx)(eW.Z,{control:(0,r.jsx)(k.Qr,{name:"proformaInvoice",control:n,render:function(e){var n=e.value,t=e.onChange;return(0,r.jsx)(e6,{checked:n,onChange:function(e,n){return t(n)},color:"danger"})}}),label:"Proforma Invoice"}),(0,r.jsx)(eW.Z,{control:(0,r.jsx)(k.Qr,{name:"unpaid",control:n,render:function(e){var n=e.value,t=e.onChange;return(0,r.jsx)(e6,{checked:n,onChange:function(e,n){return t(n)},color:"danger"})}}),label:"Unpaid"}),(0,r.jsx)(eW.Z,{control:(0,r.jsx)(k.Qr,{name:"partiallyPaid",control:n,render:function(e){var n=e.value,t=e.onChange;return(0,r.jsx)(e6,{checked:n,onChange:function(e,n){return t(n)},color:"pink"})}}),label:"Parially Paid"}),(0,r.jsx)(eW.Z,{control:(0,r.jsx)(k.Qr,{name:"paid",control:n,render:function(e){var n=e.value,t=e.onChange;return(0,r.jsx)(e6,{checked:n,onChange:function(e,n){return t(n)},color:"success"})}}),label:"Paid"})]})]})})},e5=t(84193),e4=t(35374),e9=eu.Z,e8=function(e){var n=e.xeroUserId,t=e.showXeroSyncButton,i=e.onClickXeroSync,o=e.showSyncEntriesWithXero,a=e.downloadCsv,s=e.csvDownloading;return(0,r.jsxs)(ee.Z,{direction:"row",alignItems:"center",spacing:2,children:[!!n&&t&&(0,r.jsx)(e9,{varinat:"contained",color:"info",onClick:function(e){e.preventDefault(),e.stopPropagation(),i()},children:"Connect to Xero"}),!!n&&!t&&(0,r.jsx)(e9,{varinat:"contained",color:"info",onClick:function(e){e.preventDefault(),e.stopPropagation(),o()},children:"Send Account Entries to Xero"}),!(0,e4.s)()&&(0,r.jsx)(e9,{disabled:s,disableMinWidth:!0,variant:"contained",color:"success",onClick:function(e){e.stopPropagation(),a()},children:s?(0,r.jsx)(et.Z,{size:30,color:"success"}):(0,r.jsx)(e5.Z,{})})]})},e7=t(95839),ne=function(e){var n,t,s,c,l,m,v,p=e.type,f=e.accountId,h=e.edit,b=e.locationId,x=e.xeroUserId,g=e.xeroCompanyId,y=e.showXeroSyncButton,I=e.onClickXeroSync,j=e.onSendEntitiesToXero,Z=(e.onSendPaymentToXero,e.onReceiveUpdatesFromXero),_=(0,e2.Z)("(max-width:600px)"),C=(0,a.useState)(!1),w=C[0],T=C[1],R=(0,ez.a)(),A=(0,X.x)().user,$=(0,J.x)(),D=(0,ed.q)(),q=A.adminId,P=null===(n=D.admin)||void 0===n?void 0:null===(t=n.jobSetting)||void 0===t?void 0:t.jobNumberPrefix,F=null===(s=D.admin)||void 0===s?void 0:null===(c=s.jobSetting)||void 0===c?void 0:c.jobNumberSuffix,E=(0,a.useState)({}),L=E[0],W=E[1],M=(0,ej.x)({filters:L}),B=M.initialData,Y=M.ref,en=(0,k.cI)({defaultValues:(0,N.Z)({},nn)}),et=en.control,er=en.handleSubmit,ec=en.watch,em=L.startDate,ep=L.endDate,ef=L.invoiceNumber,eh=L.outstandingLevel,eb=ec("creditNote"),eg=ec("paymentReceipt"),ey=ec("proformaInvoice"),eI=ec("unpaid"),eZ=ec("partiallyPaid"),eC=ec("paid"),eN=(0,a.useMemo)(function(){return eH({accountId:f,locationId:b,startDate:em,endDate:ep,invoiceNumber:ef,outstandingLevel:eh,type:{creditNote:eb,paymentReceipt:eg,proformaInvoice:ey,unpaid:eI,partiallyPaid:eZ,paid:eC}})},[f,eb,ep,ef,b,eh,eC,eZ,eg,ey,em,eI]),eA=(0,u.a)(d.v8,{variables:{limit:B.limit,offset:B.offset,accountId:f,locationId:b,orderBy:B.orderBy,where:eN}}),ek=eA.data,e$=void 0===ek?{accountEntries:[],meta:{aggregate:{totalCount:0,debitTotal:{debit:0},creditTotal:{credit:0},balance:{balance:0}}}}:ek,eq=e$.accountEntries,eP=e$.meta,eF=eA.loading,eE=eA.refetch,eL=(0,S.Z)((0,U.t)(d.UA,{variables:{limit:null,offset:0,accountId:f,locationId:b,orderBy:B.orderBy,where:eN},onCompleted:function(e){var n=ex(e.accountEntries,{numberPrefix:P,numberSuffix:F}),t=O().unparse(n),i="data:application/octet-stream,"+encodeURIComponent(t);(0,eO.S)(i,"account-entries.csv")}}),2),eW=eL[0],eM=eL[1].loading,eB=eP.aggregate.debitTotal.debit,eJ=eP.aggregate.creditTotal.credit,eU=function(){R.show({content:(0,r.jsx)(eR.q,{type:p,accountId:f,locationId:b,refetch:eE,close:R.close}),title:"Add Payment Received",xs3:"100vw",sm:"100vw",sm2:"100vw",sm3:"80vw",md2:"80vw",lg:"80vw",lg2:"80vw"})},eK=function(){R.show({content:(0,r.jsx)(eY,{type:p,accountId:f,locationId:b,refetch:eE,close:R.close}),title:"Add credit note",xs3:"100vw",sm:"100vw",sm2:"100vw",sm3:"80vw",md2:"80vw",lg:"80vw",lg2:"80vw"})},e0=function(){R.show({content:(0,r.jsx)(ew,{accountId:f,locationId:b,adminId:q,toggleShow:R.close,onSendEntities:e6}),title:"Send Account Entries to Xero",xs3:"100vw",sm:"100vw",sm2:"100vw",sm3:"40vw",md2:"40vw",lg:"40vw",lg2:"40vw"})},e1=(0,a.useCallback)((l=(0,i.Z)(function(e,n){var t,i,r,a,s,c,u,d,l;return(0,o.__generator)(this,function(o){switch(o.label){case 0:switch(e.preventDefault(),e.stopPropagation(),i=void 0===(t=n.invoice)?{}:t,r=n.itemType){case"proformaInvoice":return[3,1];case"invoice":return[3,3];case"customerPpmInvoice":return[3,4];case"supplierPpmInvoice":return[3,6]}return[3,7];case 1:return[4,$.query({query:eV.WG,variables:{id:i.id}})];case 2:return u=o.sent().data.invoice,(0,eS.u)({meta:null==u?void 0:null===(a=u.accountEntry)||void 0===a?void 0:a.meta,invoice:u}),[3,8];case 3:return(0,eT._Z)({client:$,jobId:n.jobId,type:i.invoiceType}),[3,8];case 4:return[4,$.query({query:eV.Wj,variables:{accountEntryId:n.id}})];case 5:return l=o.sent().data.accountEntry,(0,eX.$)(l.meta),[3,8];case 6:return(0,e7.W)({client:$,accountEntryId:n.id}),[3,8];case 7:return[3,8];case 8:return[2]}})}),function(e,n){return l.apply(this,arguments)}),[$]),e6=(0,a.useCallback)((m=(0,i.Z)(function(e,n){return(0,o.__generator)(this,function(t){return T(!0),j({accountId:f,entities:e}).then(function(){eE(),T(!1),R.close(),n&&n()}),[2]})}),function(e,n){return m.apply(this,arguments)}),[f,R,j,eE]),e5=(0,a.useCallback)((v=(0,i.Z)(function(e,n){var t,i,r,a,s;return(0,o.__generator)(this,function(o){switch(o.label){case 0:return e.preventDefault(),e.stopPropagation(),t=n.id,i=n.itemType,a=void 0===(r=n.invoice)?[]:r,s=[],"creditNote"===i?s.push({entity:"creditNote",id:t}):s.push({entity:i,invoiceType:a.invoiceType||null,invoiceId:t||null}),[4,e6(s)];case 1:return o.sent(),[2]}})}),function(e,n){return v.apply(this,arguments)}),[e6]),e4=(0,a.useCallback)(function(e){var n,t,i,o,r=[{icon:"download",onClick:function(n){return e1(n,e)},tooltip:"Download",disabled:"creditNote"===e.itemType||"paymentReceipt"===e.itemType}];return x&&!((null===(n=e.meta)||void 0===n?void 0:n.xeroInvoiceId)||(null===(t=e.meta)||void 0===t?void 0:t.xeroCreditNoteId))&&"paymentReceipt"!==e.itemType&&"creditNote"!==e.itemType&&r.unshift({icon:"info",onClick:function(n){return e5(n,e)},tooltip:"Sync invoice with Xero",disabled:y||w}),x&&(null===(i=e.meta)||void 0===i?void 0:i.xeroInvoiceId)&&(r.unshift({icon:"check",tooltip:"Sync",disabled:!0}),(null===(o=e.meta)||void 0===o?void 0:o.syncedWithXero)||r.unshift({icon:"info",onClick:function(n){return Z(n,e)},tooltip:"Invoice has changes in Xero. Click to update it in Cleverly"})),r},[e1,w,Z,y,e5,x]),e9=(0,a.useMemo)(function(){return[{sortable:!1,flex:1,minWidth:180,headerName:"Type",field:"type",renderCell:function(e){var n=e.row;return(0,r.jsx)(eD.Z,{label:n.itemType,color:e_({itemType:n.itemType,paymentStatus:n.paymentStatus}),size:"small",sx:{borderRadius:1}})}},{sortable:!1,flex:1,minWidth:180,headerName:"Number",field:"number",renderCell:function(e){var n=e.row;return z.YK.includes(n.itemType)?"PM ".concat(null==n?void 0:n.invoiceNumber):(0,r.jsx)(V.D,{id:n.jobId,number:n.number,invoiceNumber:null==n?void 0:n.invoiceNumber,numberPrefix:P,numberSuffix:F,openCanvas:!!n.jobId,type:n.jobType})}},{sortable:!1,flex:1,minWidth:180,headerName:"Reference",field:"reference"},{sortable:!1,flex:1,minWidth:180,headerName:"Date",field:"date"},{sortable:!1,flex:1,minWidth:120,headerName:"Days Outstanding",field:"outstandingDays"},{sortable:!1,flex:1,minWidth:120,headerName:"Amount Outstanding",field:"outstandingAmount",renderCell:function(e){var n=e.row;return"creditNote"===n.itemType||"paymentReceipt"===n.itemType?"-":(0,es.T)(n.outstandingAmount)}},{sortable:!1,flex:1,minWidth:140,headerName:"Status",field:"status",renderCell:function(e){var n=e.row;return n.status?(0,r.jsx)(el.B,{value:n.status}):""}},{sortable:!1,flex:1,minWidth:120,headerName:"Debit",field:"debit",renderCell:function(e){var n=e.row;return n.debit?(0,es.T)(n.debit):"-"}},{sortable:!1,flex:1,minWidth:120,headerName:"Credit",field:"credit",renderCell:function(e){var n=e.row;return n.credit?(0,es.T)(n.credit):"-"}},{sortable:!1,flex:1,minWidth:120,headerName:"Balance",field:"balance",renderCell:function(e){var n=e.row;return(0,es.T)(n.balance)}},{sortable:!1,minWidth:120,headerName:"Actions",field:"actions",renderCell:function(e){var n=e.row;return(0,r.jsx)(eQ.C,{actionsData:e4,row:n})}}]},[e4,P,F]),ne=(0,a.useMemo)(function(){return eq.map(function(e){var n,t,i,o,r,a,s,c,u,d,l,m,v,p="creditNote"!==e.type&&"paymentReceipt"!==e.type?e.outstandingdays:"-",f=null===(n=e.invoices)||void 0===n?void 0:n[0];return{id:e.id,jobId:null==f?void 0:null===(t=f.Job)||void 0===t?void 0:t.id,jobIds:null===(i=e.invoices)||void 0===i?void 0:i.map(function(e){var n;return null==e?void 0:null===(n=e.job)||void 0===n?void 0:n.id}),number:null==f?void 0:null===(o=f.Job)||void 0===o?void 0:o.number,itemType:e.type,jobType:null==f?void 0:null===(r=f.Job)||void 0===r?void 0:r.type,invoiceNumber:e.invoiceNumber,invoice:f,reference:null===(a=e.meta)||void 0===a?void 0:a.reference,comment:null===(s=e.meta)||void 0===s?void 0:s.comment,date:ea()(e.createdAt).format("YYYY-MM-DD"),outstandingDays:p,service:null==f?void 0:null===(c=f.Job)||void 0===c?void 0:null===(u=c.service)||void 0===u?void 0:u.name,address:null==f?void 0:null===(d=f.Job)||void 0===d?void 0:null===(l=d.location)||void 0===l?void 0:l.name,outstandingAmount:e.outstandingAmount,status:null==f?void 0:null===(m=f.Job)||void 0===m?void 0:m.status,debit:e.debit,credit:e.credit,balance:e.balance,paid:null==f?void 0:null===(v=f.Job)||void 0===v?void 0:v.paid,paymentStatus:e.paymentStatus,entryId:e.entryId,meta:e.meta,actions:""}})},[eq]),nt=(0,a.useCallback)(function(e){var n=e.row;R.show({content:(0,r.jsx)(ev,{accountEntryId:n.id,close:R.close}),title:"Account Entry Details",xs3:"100vw",sm:"100vw",sm2:"100vw",sm3:"40vw",md2:"40vw",lg:"40vw",lg2:"40vw"})},[R]);return(0,r.jsxs)(Q.Z,{defaultExpanded:!0,children:[(0,r.jsx)(K.Z,{expandIcon:(0,r.jsx)(eo.Z,{}),children:(0,r.jsxs)(ee.Z,{direction:"row",justifyContent:"space-between",width:"100%",pr:2,children:[(0,r.jsx)(H.Z,{variant:"h6",children:"Account Entries"}),(0,r.jsx)(e8,{xeroUserId:x,xeroCompanyId:g,onClickXeroSync:I,showSyncEntriesWithXero:e0,downloadCsv:eW,csvDownloading:eM})]})}),(0,r.jsxs)(G.Z,{children:[(0,r.jsx)(e3,{control:et,setFilters:W,handleSubmit:er}),(0,r.jsx)(ei.i,{ref:Y,columns:e9,rows:ne,meta:eP,loading:eF,refetch:eE,onRowClick:nt,columnVisibilityModel:{outstandingDays:!h}}),(0,r.jsxs)(ee.Z,{width:"100%",mt:2,spacing:2,children:[(0,r.jsxs)(ee.Z,{direction:_?"column":"row",width:"100%",justifyContent:"flex-end",spacing:1,children:[(0,r.jsx)(eD.Z,{label:"Total Debit: ".concat((0,es.T)(eB)),color:"info"}),(0,r.jsx)(eD.Z,{label:"Total Credit: ".concat((0,es.T)(eJ)),color:"info"}),(0,r.jsx)(eD.Z,{label:"Balance: ".concat((0,es.T)(eB-eJ)),color:"".concat(eB-eJ<0?"warning":"success")})]}),(0,r.jsx)(eG.Z,{}),(0,r.jsx)(ee.Z,{width:"100%",direction:"row",justifyContent:"flex-end",spacing:2,children:h&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(eu.Z,{variant:"contained",color:"secondary",onClick:eU,children:"Add Payment Received"}),"customer"===p&&(0,r.jsx)(eu.Z,{variant:"contained",color:"secondary",onClick:eK,children:"Add Credit note"})]})})]})]})]})};ne.propTypes={type:(0,s.oneOf)(["customer","supplier"]).isRequired,accountId:s.number.isRequired,edit:s.bool,locationId:s.number,xeroUserId:s.string,xeroCompanyId:s.string,showXeroSyncButton:s.bool,onClickXeroSync:s.func,onSendEntitiesToXero:s.func},ne.defaultProps={edit:!0};var nn={startDate:null,endDate:null,invoiceNumber:"",outstandingLevel:null,creditNote:!0,paymentReceipt:!0,proformaInvoice:!0,unpaid:!0,partiallyPaid:!0,paid:!0},nt=t(99534),ni=t(79665),no=t(32979),nr=(0,eJ.Ry)().shape({serviceRateType:(0,eJ.Z_)().when("rateType",{is:"serviceRate",then:function(){return(0,eJ.Z_)().oneOf(["grossPercent","costPlus"]).required("This field is required!")}}),serviceRateLabour:(0,eJ.Rx)().when("rateType",{is:"serviceRate",then:function(){return(0,eJ.Rx)().min(0).required()}}),serviceRateExpenses:(0,eJ.Rx)().when("rateType",{is:"serviceRate",then:function(){return(0,eJ.Rx)().min(0).required()}}),arrangementFee:(0,eJ.Rx)().when("rateType",{is:"rebate",then:function(){return(0,eJ.Rx)().min(0).lessThan(100,"Rebate can`t be more than 99.99%").required()}}),approvalThreshold:(0,eJ.Rx)().min(0).required(),spendThreshold:(0,eJ.Rx)().min(0).required(),invoiceDueDate:(0,eJ.Rx)().min(0).required()}),na=t(69297),ns=t(64811),nc=t(21023),nu=t(48999),nd=t(5616),nl=t(10166),nm=function(e){var n,t=e.accountId,a=e.meta,s=e.refetch,c=e.toggleShow,u=(0,J.x)(),d=(0,N.Z)({},null==a?void 0:a.finance),l=(0,k.cI)({defaultValues:{approvalThreshold:d.approvalThreshold||0,arrangementFee:d.arrangementFee||0,serviceRateLabour:d.serviceRateLabour||0,serviceRateExpenses:d.serviceRateExpenses||0,spendThreshold:d.spendThreshold||0,invoiceDueDate:d.invoiceDueDate||0,rateType:(d.serviceRateLabour||d.serviceRateExpenses)&&"serviceRate"||d.arrangementFee&&"rebate",serviceRateType:d.serviceRateType},resolver:(0,ni.S)(nr)}),m=l.errors,v=l.handleSubmit,p=l.register,f=l.watch,h=l.control,b=(0,S.Z)((0,R.D)(A.Wn,{onCompleted:(0,i.Z)(function(){return(0,o.__generator)(this,function(e){switch(e.label){case 0:return[4,(0,ns.j)({client:u,customerId:t})];case 1:return e.sent(),[2]}})})}),1)[0],x=(n=(0,i.Z)(function(e){return(0,o.__generator)(this,function(n){return b({variables:{customerId:t,customer:y(e),hasUpdateUser:!1,userId:t}}).then(function(){s(),c()}),[2]})}),function(e){return n.apply(this,arguments)}),g=f("rateType"),y=function(e){var n={};return n.meta=(0,N.Z)({},a),n.meta.finance=d||{},"serviceRate"===g?(n.meta.finance.serviceRateType=e.serviceRateType,n.meta.finance.serviceRateLabour=e.serviceRateLabour,n.meta.finance.serviceRateExpenses=e.serviceRateExpenses,n.meta.finance.arrangementFee=0):"rebate"===g&&(n.meta.finance.serviceRateLabour=0,n.meta.finance.serviceRateExpenses=0,n.meta.finance.arrangementFee=e.arrangementFee),n.meta.finance.approvalThreshold=e.approvalThreshold,n.meta.finance.spendThreshold=e.spendThreshold,n.meta.finance.invoiceDueDate=e.invoiceDueDate,n},I={errors:m,register:p,type:"number"},j={direction:"row",sx:{"& .MuiTypography-root":{fontFamily:"Arial,sans-serif,sans-serif"}}},Z=function(e){return function(n){var t=n.children;return(0,r.jsx)(nv,{title:e,children:t})}};return(0,r.jsxs)($.Z,{id:"offCanvasForm",handleSubmit:v(x),children:[(0,r.jsx)(nd.Z,{children:(0,r.jsx)(k.Qr,{name:"rateType",control:h,render:function(e){var n,t=e.value,i=e.onChange;return(0,r.jsx)(na.E,{stackProps:j,formControlProps:{sx:{m:0}},value:t,onChange:i,options:[{label:"Service Rate",value:"serviceRate"},{label:"Rebate",value:"rebate"}],error:m.rateType,helperText:null===(n=m.rateType)||void 0===n?void 0:n.message})}})}),"serviceRate"===g&&(0,r.jsxs)(nd.Z,{children:[(0,r.jsx)(k.Qr,{name:"serviceRateType",control:h,render:function(e){var n,t=e.value,i=e.onChange;return(0,r.jsx)(na.E,{stackProps:j,formControlProps:{sx:{m:0}},value:t,onChange:i,options:[{label:"% of Gross",value:"grossPercent",ParentComponent:Z("This will calculate your service rate as a % of the customer invoice e.g.\n                      if this is 5%, you will earn \xa35 on a \xa3100 customer invoice.")},{label:"Cost plus",value:"costPlus",ParentComponent:Z("Cost plus will add the percentage indicated to the supplier amount e.g.\n                      if this is 5% on a \xa3100 supplier invoice, customer invoice will be \xa3105.")}],error:m.serviceRateType,helperText:null===(n=m.serviceRateType)||void 0===n?void 0:n.message})}}),(0,r.jsxs)(q.Z,{label:"Service Rate",children:[(0,r.jsx)(no.Z,(0,T.Z)((0,N.Z)({},I),{label:"Labour",name:"serviceRateLabour"})),(0,r.jsx)(no.Z,(0,T.Z)((0,N.Z)({},I),{label:"Expenses and Materials",name:"serviceRateExpenses"}))]})]}),"rebate"===g&&(0,r.jsx)(no.Z,(0,T.Z)((0,N.Z)({},I),{label:"Rebate",name:"arrangementFee"})),(0,r.jsx)(D.Z,(0,T.Z)((0,N.Z)({},I),{label:"Approval Threshold",name:"approvalThreshold"})),(0,r.jsx)(D.Z,(0,T.Z)((0,N.Z)({},I),{label:"Spend Threshold",name:"spendThreshold"})),(0,r.jsx)(q.Z,{label:"Invoice Due Date",children:(0,r.jsx)(P.Z,(0,T.Z)((0,N.Z)({},I),{name:"invoiceDueDate"}))})]})};nm.propTypes={meta:s.object,refetch:s.func.isRequired,toggleShow:s.func.isRequired};var nv=(0,nl.Z)(function(e){var n=e.className,t=(0,nt.Z)(e,["className"]);return(0,r.jsx)(nc.Z,(0,T.Z)((0,N.Z)({},t),{classes:{popper:n}}))})(function(e){var n=e.theme;return(0,eA.Z)({},"& .".concat(nu.Z.tooltip),{backgroundColor:n.palette.dark.main,boxShadow:n.shadows[1],fontSize:13})}),np=t(51466),nf=(0,eJ.Ry)().shape({code:(0,eJ.Z_)()}),nh=function(e){var n,t=e.onSuccess,a=e.meta,s=e.accountId,c={code:null==a?void 0:a.sageCode},u=(0,k.cI)({defaultValues:c,resolver:(0,ni.S)(nf)}),d=u.control,l=u.errors,m=u.handleSubmit,v=u.register,p=(0,S.Z)((0,R.D)(A.Wn,{onCompleted:t}),2),f=p[0],h=p[1].error,b=(n=(0,i.Z)(function(e){var n,t;return(0,o.__generator)(this,function(i){return n=e.code,(t=(0,N.Z)({},a)).sageCode=n,f({variables:{customerId:s,customer:{meta:t}}}),[2]})}),function(e){return n.apply(this,arguments)});return(0,r.jsxs)($.Z,{id:"offCanvasForm",handleSubmit:m(b),children:[(0,r.jsx)(q.Z,{label:"Sage Code",children:(0,r.jsx)(P.Z,(0,T.Z)((0,N.Z)({},{control:d,errors:l,register:v}),{name:"code"}))}),(0,r.jsx)(np.Z,{children:null==h?void 0:h.message})]})};nh.propTypes={accountId:s.number.isRequired,meta:s.object,onSuccess:s.func.isRequired};var nb=t(19192),nx=function(e){var n,t,s=e.type,y=e.accountId,I=e.accountName,j=e.accountRefetch,Z=e.locationId,_=e.meta,C=e.hasSageIntegration,w=(0,a.useState)(!1),N=w[0],T=w[1],S=(0,c.useRouter)().query,R=(0,X.x)(),A=R.hasRole,k=R.user,$=(0,nb.RM)(null==k?void 0:k.id),D=(0,ez.a)(),q=(0,a.useContext)(l.Z),P=A("admin"),F=(0,u.a)(d.Dn,{variables:{accountId:y}}),E=F.data,L=(void 0===E?{financial:{}}:E).financial,W=F.loading,B=F.refetch,J=(0,nb.BR)({adminId:k.id,xeroClientId:null==S?void 0:S.clientId,onSaveXeroTokenCallback:function(){return B()}},[k]),U=J.tokenStatus,Y=J.onCallAuthorize,O=J.onCallRefreshToken,V=J.onSendEntitiesToXero,z=J.onSendPaymentToXero,Q=J.onReceiveUpdatesFromXero;(0,a.useEffect)(function(){"unauthenticated"===U||"disconnected"===U?T(!0):T(!1)},[U]);var G=(null==_?void 0:_.finance)||{},K=L.bankAccounts,H=function(){q.close(),j()},ee=function(e){e.stopPropagation(),q.show({content:(0,r.jsx)(nh,{meta:_,onSuccess:H,accountId:y}),title:(null==_?void 0:_.sageCode)?"Add Sage Code":"Update Sage Code"})},en=function(e){e.stopPropagation(),D.show({content:(0,r.jsx)(nm,{accountId:y,meta:_,refetch:j,toggleShow:D.close}),title:"Edit Finance Details"})};if(W)return null;var et,ei,eo,er=function(){return(0,r.jsx)(v.Z,{children:(0,r.jsx)(p.Z,{context:"secondary",content:"Edit",onClick:en,size:"sm"})})},ea=function(){return(0,r.jsx)(v.Z,{children:(0,r.jsx)(p.Z,{context:"secondary",content:"Edit",onClick:ee,size:"sm"})})},es=(et=(0,i.Z)(function(e,n){var t,i;return(0,o.__generator)(this,function(o){switch(o.label){case 0:return e.preventDefault(),e.stopPropagation(),[4,Q((null===(t=n.meta)||void 0===t?void 0:t.xeroInvoiceId)||(null===(i=n.meta)||void 0===i?void 0:i.xeroCreditNoteId),null==$?void 0:$.companyId,y)];case 1:return o.sent(),B(),[2]}})}),function(e,n){return et.apply(this,arguments)});return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(f.Z,{children:(0,r.jsx)(h.Z,{md:12,children:(0,r.jsx)(ne,{type:s,accountId:y,accountName:I,edit:P,locationId:Z,meta:_,xeroCompanyId:null==$?void 0:$.companyId,xeroUserId:null==$?void 0:$.clientId,refetchXeroToken:O,showXeroSyncButton:N,onSendEntitiesToXero:V,onClickXeroSync:function(){return Y(window.location.href)},onSendPaymentToXero:z,onReceiveUpdatesFromXero:es})})}),A("admin")&&(0,r.jsxs)(f.Z,{children:[(0,r.jsxs)(h.Z,{md:"customer"===s?6:12,children:["customer"===s&&(0,r.jsx)(b.Z,{toolbar:P&&(0,r.jsx)(er,{}),title:"Overview",open:!0,children:(0,r.jsx)(x.Z,{rows:[{key:"Service Rate Labour",value:"".concat(G.serviceRateLabour||0,"%")},{key:"Service Rate Expenses and Materials",value:"".concat(G.serviceRateExpenses||0,"%")},{key:"Rebate",value:"".concat((null==G?void 0:G.arrangementFee)||0,"%")},{key:"Approval Threshold",value:(0,m.Z)(null!==(n=null==G?void 0:G.approvalThreshold)&&void 0!==n?n:0)},{key:"Spend Threshold",value:(0,m.Z)(null!==(t=null==G?void 0:G.spendThreshold)&&void 0!==t?t:0)},{key:"Stripe ID",value:G.stripeId||"-"},{key:"Invoice Due Date",value:G.invoiceDueDate||"-"}]})}),(0,r.jsx)(g.y,{accountId:y,data:K,edit:P,refetch:j}),"customer"===s&&(0,r.jsx)(b.Z,{toolbar:(0,r.jsx)(ea,{}),title:"Integration",open:!0,children:(0,r.jsx)(x.Z,{rows:(eo=[],C&&eo.push({key:"Sage Code",value:(null==_?void 0:null===(ei=_.sageCode)||void 0===ei?void 0:ei.length)>0?null==_?void 0:_.sageCode:"not set"}),eo)})})]}),(0,r.jsxs)(h.Z,{md:6,children:["customer"===s&&(0,r.jsx)(b.Z,{title:"Balance",open:!0,children:(0,r.jsx)(x.Z,{rows:[{key:"Total Outstanding",value:(0,m.Z)(G.amountOutstanding||0)},{key:"Total Revenues",value:(0,m.Z)(G.totalRevenue||0)}]})}),"customer"===s&&(0,r.jsx)(M,{accountId:y,edit:P,meta:_,offCanvas:D,refetch:j,customerBalance:0})]})]})]})};nx.propTypes={type:(0,s.oneOf)(["customer","supplier"]).isRequired,accountId:s.number.isRequired,accountName:s.string.isRequired,accountRefetch:s.func.isRequired,locationId:s.number.isRequired,meta:s.object.isRequired}},32725:function(e,n,t){t.d(n,{E:function(){return J}});var i=t(47568),o=t(26042),r=t(828),a=t(97582),s=t(85893),c=t(67294),u=t(45697),d=t(6812),l=t(50319),m=t(7297),v=t(75063);function p(){var e=(0,m.Z)(["\n  query GetNote($entityId: Int!) {\n    note: Note(where: { entityId: { _eq: $entityId } }, order_by: { createdAt: desc }) {\n      accountId\n      comments\n      createdAt\n      id\n      userId\n      user: User {\n        nameFirst\n        nameLast\n      }\n    }\n  }\n"]);return p=function(){return e},e}function f(){var e=(0,m.Z)(["\n  mutation AddNote(\n    $accountId: Int\n    $comments: String\n    $entity: String\n    $entityId: Int\n    $userId: Int\n  ) {\n    insert_Note(\n      objects: {\n        accountId: $accountId\n        comments: $comments\n        entity: $entity\n        entityId: $entityId\n        userId: $userId\n      }\n    ) {\n      returning {\n        id\n        comments\n      }\n    }\n  }\n"]);return f=function(){return e},e}function h(){var e=(0,m.Z)(["\n  mutation UpdateNote($id: Int!, $change: Note_set_input) {\n    update_Note_by_pk(pk_columns: { id: $id }, _set: $change) {\n      id\n      comments\n    }\n  }\n"]);return h=function(){return e},e}var b=(0,v.Ps)(p()),x=(0,v.Ps)(f()),g=(0,v.Ps)(h()),y=t(78289),I=t(16551),j=t(77439),Z=t(11585),_=t(86036),C=t(69396),w=t(42283),N=t(79665),T=t(76600),S=t(9270),R=t(62140),A=t(49501),k=t(6710),$=t(55563),D=t(16310),q=(0,D.Ry)().shape({comments:(0,D.Z_)().required()}),P=function(e){var n=e.defaultValues,t=e.onSubmit,i=(0,w.cI)({defaultValues:(0,o.Z)({},n),resolver:(0,N.S)(q)}),r=i.control,a=i.errors,c=i.handleSubmit,u={control:r,errors:a,register:i.register};return(0,s.jsxs)(T.Z,{id:"offCanvasForm",handleSubmit:c(t),children:[(0,s.jsx)(S.Z,{children:(0,s.jsx)(R.Z,{md:12,children:(0,s.jsx)(A.Z,{label:"Title",children:(0,s.jsx)(k.Z,(0,C.Z)((0,o.Z)({},u),{name:"comments",rows:4}))})})}),n.id&&(0,s.jsx)($.Z,(0,C.Z)((0,o.Z)({},u),{name:"id",type:"hidden"}))]})};P.propTypes={defaultValues:u.object,onSubmit:u.func.isRequired};var F=t(68956),E=t(26186),L=t(55843),W=t(16540),M=function(e){var n=e.note,t=e.loading,i=e.handleClick,o=e.userId,r=[{hidden:!0},{hidden:!0},{text:"Title"},{text:"By"},{text:"Created"},{formatter:F.Z,formatterData:function(e){return[{context:"secondary",disabled:o!==e.userId,icon:["fas","edit"],onClick:function(e,n){return i(e,n)},tooltip:"Edit"}]},text:"Actions"}];return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(L.Z,{marginBottom:"xs"}),(0,s.jsx)(W.Z,{columns:r,loading:t,rows:n.map(function(e){var n,t;return{id:e.id,userId:e.userId,comments:e.comments,user:"".concat(null===(n=e.user)||void 0===n?void 0:n.nameFirst," ").concat(null===(t=e.user)||void 0===t?void 0:t.nameLast),date:(0,E.Z)(e.createdAt),actions:""}})})]})};M.propTypes={userId:u.number.isRequired,note:u.array.isRequired,loading:u.bool.isRequired,handleClick:u.func.isRequired},M.defaultProps={note:[]};var B=t(74944),J=function(e){var n,t=e.entity,u=e.entityId,m=(e.open,e.title),v=e.single,p=(0,c.useContext)(y.Z),f=(0,B.x)().user,h=(0,d.a)(b,{variables:{entity:t,entityId:u}}),C=h.loading,w=h.data,N=(void 0===w?{note:[]}:w).note,T=h.refetch,S=(0,r.Z)((0,l.D)(x,{onCompleted:function(){p.close(),T()}}),1)[0],R=(0,r.Z)((0,l.D)(g,{onCompleted:function(){p.close(),T()}}),1)[0],A=(n=(0,i.Z)(function(e){return(0,a.__generator)(this,function(n){switch(n.label){case 0:if(!e.id)return[3,2];return[4,R({variables:{id:e.id,change:e}})];case 1:return n.sent(),[3,4];case 2:return e.accountId=f.accountId,e.entity=t,e.entityId=u,e.userId=f.id,[4,S({variables:e})];case 3:n.sent(),n.label=4;case 4:return[2]}})}),function(e){return n.apply(this,arguments)}),k=function(e,n){e.preventDefault(),e.stopPropagation();var t=(0,o.Z)({},n);p.show({content:(0,s.jsx)(P,{defaultValues:t,onCancel:$,onSubmit:A}),title:n?"Edit note":"Add note"})},$=function(){p.close()},D=function(){return(0,s.jsx)(I.Z,{children:v&&N.length?(0,s.jsx)(j.Z,{context:"secondary",content:"Edit",onClick:function(e){return k(e,N[0])},size:"sm"}):(0,s.jsx)(j.Z,{context:"secondary",content:"Add new",onClick:k,size:"sm"})})};return(0,s.jsxs)(Z.Z,{fitParentHeight:!0,title:m,toolbar:(0,s.jsx)(D,{}),children:[v&&N.length>0&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(_.Z,{text:N[0].comments}),(0,s.jsx)(_.Z,{content:"By",text:"".concat(N[0].user.nameFirst," ").concat(N[0].user.nameLast)})]}),!v&&(0,s.jsx)(M,{entity:t,entityId:u,note:N,loading:C,refetch:T,handleClick:k,userId:f.id})]})};J.propTypes={entity:u.string.isRequired,entityId:u.number.isRequired,single:u.bool,title:u.string},J.defaultProps={open:!0,single:!1,title:"Note"}},15897:function(e,n,t){t.d(n,{bg:function(){return i}});var i=[{text:"Status",value:""},{text:"Active",value:"active"},{text:"Inactive",value:"inactive"}]},66267:function(e,n,t){t.d(n,{J:function(){return j}});var i=t(26042),o=t(69396),r=t(99534),a=t(828),s=t(85893),c=t(11163),u=t(67294),d=t(45697),l=t(9270),m=t(62140),v=t(42283),p=t(76600),f=t(11585),h=t(49501),b=t(75903),x=t(77439),g=t(31113),y=t(45307),I=function(e){var n=e.initialValues,t=e.renderFilters,r=e.setFilters,c=e.lastQuery,d=e.filters,I=(0,a.Z)((0,y.X)("form_data_".concat(n.filterType),n),2),j=I[0],Z=I[1],_=(0,v.cI)({defaultValues:j||n}),C=_.control,w=_.errors,N=_.handleSubmit,T=_.register,S=_.reset,R=_.watch,A=_.setValue,k=R(),$=(0,o.Z)((0,i.Z)({},k),{filterType:n.filterType});(0,u.useEffect)(function(){S($)},[S]),(0,u.useEffect)(function(){Z($)},[d]);var D=function(e){var t=e.query;if(t!==c){var o={q:"%".concat(t,"%")||0},a=/^\d+$/.test(t);"id"in n&&(o.id=a?Number(t):null),"meta"in n&&(o.meta=a?{invoiceNumbers:[t]}:null),"jobNumber"in n&&(o.jobNumber=a?String(t):null,o.invoiceNumber=a?Number(t):null),r(function(e){return(0,i.Z)({},e,o)})}},q=function(e){Object.keys(n).map(function(e){return A(e,null)}),r(n),S(n),D("")};return(0,s.jsx)(p.Z,{handleSubmit:N(D),children:(0,s.jsxs)(f.Z,{title:"Filters",children:[(0,s.jsxs)(l.Z,{children:[(0,s.jsx)(m.Z,{sm:12,lg:12,children:(0,s.jsx)(h.Z,{label:"",children:(0,s.jsx)(b.Z,{errors:w,label:"Search",name:"email",placeholder:"Search...",prependSearchIcon:!0,register:T,type:"search"})})}),(0,s.jsx)(m.Z,{sm:12,lg:12,children:t({control:C,errors:w,initialValues:n,register:T,setFilters:r,watch:R,setValue:A,reset:S})})]}),(0,s.jsx)(g.H,{content:"Search",context:"secondary",handleClick:D,type:"submit",children:(0,s.jsx)(x.Z,{content:"Clear",context:"danger",onClick:q,size:"sm"})})]})})};I.propTypes={initialValues:d.object,renderFilters:d.func.isRequired,setFilters:d.func.isRequired};var j=function(e){var n=e.FiltersComp,t=e.initialFilters,d=e.TableComp,v=(0,r.Z)(e,["FiltersComp","initialFilters","TableComp"]),p=(0,a.Z)((0,y.X)("form_data_".concat(t.filterType),t),2),f=p[0],h=p[1],b=(0,u.useState)(f||t),x=b[0],g=b[1],j=(0,c.useRouter)().query.show;return(0,u.useEffect)(function(){h(x)},[x,h]),(0,s.jsx)(l.Z,{children:(0,s.jsxs)(m.Z,{sm:12,lg:12,children:[(0,s.jsx)(I,{initialValues:t,renderFilters:function(e){return(0,s.jsx)(n,(0,o.Z)((0,i.Z)({},e,v),{show:j}))},setFilters:g,filters:x}),(0,s.jsx)(d,(0,i.Z)({filters:x,initialFilters:t},v))]})})};j.propTypes={FiltersComp:d.func,initialFilters:d.object.isRequired,TableComp:d.func}}}]);